using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Text;
using System.Linq;
using System.Threading.Tasks;
using System.Windows.Forms;
using DevExpress.XtraEditors;
using DBHesabdari_PG;
using System.Data.Entity;
using KharidVaFroosh.AmaliatFrooshVKharid;
using DevExpress.XtraGrid.Views.Grid;
using HelpClassLibrary;
using DBHesabdari_PG.Models.EP.CodingHesabdari;
using DBHesabdari_PG.Models.FK;
using DevExpress.XtraGrid;

namespace FrooshVKharid.AmaliatFrooshVKharid
{
    public partial class FrmFactor : DevExpress.XtraEditors.XtraForm
    {
        MyContext dbContext;
        public FrmFactor()
        {
            InitializeComponent();
            //// This line of code is generated by Data Source Configuration Wizard
            //// Instantiate a new DBContext
            //DBHesabdari_PG.MyContext dbContext = new DBHesabdari_PG.MyContext();
            //// Call the Load method to get the data for the given DbSet from the database.
            //dbContext.EpListAnbarhas.Load();
            //// This line of code is generated by Data Source Configuration Wizard
            //epListAnbarhasBindingSource.DataSource = dbContext.EpListAnbarhas.Local.ToBindingList();
            // This line of code is generated by Data Source Configuration Wizard
            // Instantiate a new DBContext
            //DBHesabdari_PG.MyContext dbContext = new DBHesabdari_PG.MyContext();
            //// Call the Load method to get the data for the given DbSet from the database.
            //dbContext.FkAmaliatFrooshVKharid_Rizs.Where(s => s.Id == 0).Load();
            //// This line of code is generated by Data Source Configuration Wizard
            //fkAmaliatFrooshVKharid_RizsBindingSource_Kala.DataSource = dbContext.FkAmaliatFrooshVKharid_Rizs.Local.ToBindingList();
            //// This line of code is generated by Data Source Configuration Wizard
            //// Instantiate a new DBContext
            //DBHesabdari_PG.MyContext dbContext = new DBHesabdari_PG.MyContext();
            //// Call the Load method to get the data for the given DbSet from the database.
            //dbContext.FkAmaliatFrooshVKharid_Rizs.Load();
            //// This line of code is generated by Data Source Configuration Wizard
            //fkAmaliatFrooshVKharid_RizsBindingSource_Khadamat.DataSource = dbContext.FkAmaliatFrooshVKharid_Rizs.Local.ToBindingList();
        }

        FrmListFrooshVKharid Fm;
        public FrmFactor(FrmListFrooshVKharid fm)
        {
            InitializeComponent();
            Fm = fm;
            //// This line of code is generated by Data Source Configuration Wizard
            //// Instantiate a new DBContext
            //DBHesabdari_PG.MyContext dbContext = new DBHesabdari_PG.MyContext();
            //// Call the Load method to get the data for the given DbSet from the database.
            //dbContext.EpListAnbarhas.Load();
            //// This line of code is generated by Data Source Configuration Wizard
            //epListAnbarhasBindingSource.DataSource = dbContext.EpListAnbarhas.Local.ToBindingList();
            // This line of code is generated by Data Source Configuration Wizard
            // Instantiate a new DBContext
            dbContext = new DBHesabdari_PG.MyContext();
            // Call the Load method to get the data for the given DbSet from the database.
            dbContext.FkAmaliatFrooshVKharid_Rizs.Where(s => s.Id == 0).Load();
            // This line of code is generated by Data Source Configuration Wizard
            fkAmaliatFrooshVKharid_RizsBindingSource_Kala.DataSource = dbContext.FkAmaliatFrooshVKharid_Rizs.Local.ToBindingList();
        }


        int _SalId = 0;

        public bool _FirstSelectAnbar_NextSanad = false;
        public EnumCED En1 = EnumCED.Cancel;
        public EnumCED En2;
        public int _AnbarId = 0;
        //public int _BeAnbarId = 0;
        public int _KalaId = 0;
        public int _VahedeKalaId = 0;
        public string _AnbarName_NM = string.Empty;
        //public string _BeAnbarName_NM = string.Empty;
        public string _KalaCode_NM = string.Empty;
        public string _KalaName_NM = string.Empty;
        public string _VahedeKala_NM = string.Empty;
        public decimal _Meghdar = 0;
        public decimal _Nerkh = 0;
        public decimal _Mablag = 0;
        public string _Tozihat = string.Empty;
        public int _RowHandle = 0;
        public int _HesabMoinId = 0;
        public int _HesabTafsili1Id = 0;
        public int _HesabTafsili2Id = 0;
        public int _HesabTafsili3Id = 0;
        public string _SharhSanad = string.Empty;
        public int _NameSanadIndex = 0;
        public int _NameAmaliatCode = 0;
        public int _NameSanadCode = 0;
        public string _NameSanadText = string.Empty;
        public byte _NoeFactor = 0;
        public int _NoeSanadIndex = -1;
        public string _NoeSanadText = string.Empty;
        public int _SanadMabnaId = 0;
        public int _SefareshId = 0;
        //public string _NoeAghlamText = string.Empty;
        //public int _NoeAghlamIndex = 0;
        //public GridControl gridControl;
        //public GridView gridView;
        public GridControl gridControl1;
        public GridView gridView1;


        public int _FNumber_BeNameAmaliat_BeSelectAnbar = 0;
        public int _FNumber_BaNameAmaliat_BeSelectAnbar = 0;
        public int _FNumberCol_BaNameSanad_BeSelectAnbar = 0;
        public int _FNumber_BaNameAmaliat_BaSelectAnbar = 0;
        public int _FNumberJoze_BaNameSanad_BaSelectAnbar = 0;
        public int _FNumberJoze_BaNameSanad_BaNoeFactor = 0;

        public int _SNumber_BeNameAmaliat_BeSelectAnbar = 0;
        public int _SNumber_BaNameAmaliat_BeSelectAnbar = 0;
        public int _SNumberCol_BaNameSanad_BeSelectAnbar = 0;
        public int _SNumber_BaNameAmaliat_BaSelectAnbar = 0;
        public int _SNumberJoze_BaNameSanad_BaSelectAnbar = 0;


        public void FillCmbAnbarName()
        {
            using (var db = new MyContext())
            {
                try
                {
                    _SalId = Convert.ToInt32(lblSalId.Text);

                    var q1 = db.EpListAnbarhas.Where(s => s.SalId == _SalId).OrderBy(s => s.Code).ToList();
                    if (q1.Count > 0) epListAnbarhasBindingSource.DataSource = q1; else epListAnbarhasBindingSource.Clear();

                    //var q = db.EpListAnbarhas.Where(s => s.SalId == _SalId).ToList();

                    #region MyRegion
                    //var q1 = db.EpListAnbarhas.Where(s => s.SalId == _SalId && s.IsActive == true).OrderBy(s => s.Code).ToList();

                    //foreach (var item in q1)
                    //{
                    //    IList<int> List1 = new List<int>();
                    //    string _Id1 = String.Empty;
                    //    if (item.TabagheKalaId != null)
                    //    {
                    //        char[] item1 = item.TabagheKalaId.ToArray();
                    //        for (int i = 0; i < item1.Count(); i++)
                    //        {
                    //            if (i == 0)
                    //            {
                    //                _Id1 = _Id1 + item1[i].ToString();
                    //            }
                    //            else
                    //            {
                    //                if (item1[i] == ',')
                    //                {
                    //                    int _Id2 = Convert.ToInt32(_Id1);
                    //                    List1.Add(_Id2);
                    //                    _Id1 = String.Empty;
                    //                }
                    //                else
                    //                {
                    //                    _Id1 = _Id1 + item1[i].ToString();
                    //                }

                    //            }
                    //        }

                    //        string _KalaId = String.Empty;
                    //        foreach (var item2 in List1)
                    //        {
                    //            _KalaId += db.EpTabaghehKalas.FirstOrDefault(s => s.SalId == _SalId && s.Id == item2).Name + ",";
                    //        }
                    //        item.TabagheKalaIdName_NM = _KalaId;
                    //    }

                    //}
                    //if (q1.Count > 0)
                    //    epListAnbarhasBindingSource.DataSource = q1;
                    //else
                    //    epListAnbarhasBindingSource.Clear();

                    #endregion

                    //var q2 = db.EpTabaghehKalas.Where(s => s.SalId == _SalId).ToList();
                    //foreach (var item in q1)
                    //{
                    //    var qq = db.R_EpListAnbarha_B_EpTabaghehKalas.Where(s => s.SalId == _SalId && s.AnbarhId == item.Id).Select(s => s.TabagheKalaId).ToList();
                    //    if (qq.Count > 0)
                    //    {
                    //        string _TabagheKalaName = String.Empty;
                    //        foreach (var item2 in qq)
                    //        {
                    //            _TabagheKalaName += q2.FirstOrDefault(s => s.Id == item2).Name + ",";
                    //        }
                    //        item.TabagheKalaIdName_NM = _TabagheKalaName;
                    //    }
                    //}


                    //_SalId = Convert.ToInt32(lblSalId.Text);
                    //var q = db.EpListAnbarhas.Where(s => s.SalId == _SalId && s.IsActive == true).OrderBy(s => s.Code).ToList();
                    //cmbNameAnbar.Properties.DataSource = q.Count > 0 ? q : null;
                }
                catch (Exception ex)
                {
                    XtraMessageBox.Show("عملیات با خطا مواجه شد" + "\n" + ex.Message,
                        "پیغام", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
        }

        private void FrmFactor_Load(object sender, EventArgs e)
        {
            using (var db = new MyContext())
            {
                try
                {
                    _SalId = Convert.ToInt32(lblSalId.Text);
                    var q = db.TzTanzimatSystems.FirstOrDefault(s => s.KeyId == 4401001);
                    if (q != null)
                        _FirstSelectAnbar_NextSanad = q.IsChecked;

                    XtraTabControl1_SelectedPageChanged(null, null);

                    if (_FirstSelectAnbar_NextSanad)
                    {
                        FillCmbAnbarName();
                        if (Fm != null)
                        {
                            cmbNameAnbar.EditValue = _AnbarId;
                        }
                        if (Convert.ToInt32(cmbNameAnbar.EditValue) != 0)
                            panelControl_NameAnbar.Enabled = false;
                        //gridView.Columns["SeryalCol_BaNameAmaliat_BeSelectAnbar"].Visible = false;
                        //gridView.Columns["SeryalJoze_BaNameSanad_BeSelectAnbar"].Visible = false;
                        //lblSeryalCol_BaNameAmaliat_BeSelectAnbar.Visible = txtSeryalCol_BaNameAmaliat_BeSelectAnbar.Visible = false;
                        //lblSNumberJoze_BaNameSanad_BaSelectAnbar.Visible = txtSNumberJoze_BaNameSanad_BaSelectAnbar.Visible = false;
                        //cmbNameAnbar.Focus();
                    }
                    else
                    {
                        panelControl_NameAnbar.Enabled = false;
                        panelControl_NameAnbar.Visible = false;
                        panelControl_NameAnbar.Width = 0;
                        //xtcAmaliatRozaneh.Enabled = true;
                        //gridView.Columns["SeryalCol_BaNameAmaliat_BaSelectAnbar"].Visible = false;
                        //gridView.Columns["SeryalJoze_BaNameSanad_BaSelectAnbar"].Visible = false;
                        //lblSeryalCol_BaNameAmaliat_BaSelectAnbar.Visible = txtSeryalCol_BaNameAmaliat_BaSelectAnbar.Visible = false;
                        lblSNumberJoze_BaNameSanad_BaSelectAnbar.Visible = txtSNumberJoze_BaNameSanad_BaSelectAnbar.Visible = false;
                        txtFNumberJoze_BaNameSanad_BaSelectAnbar.Visible = lblFNumberJoze_BaNameSanad_BaSelectAnbar.Visible = false;
                        //xtc_VorodeKala.TabPages[9].Text = "جابجایی کالا";
                        //xtc_KhorojeKala.TabPages[9].Text = "جابجایی کالا";
                        //cmbNoeAghlamKala.Focus();
                    }

                    if (this.Name == "FrmFactorFrooshKala")
                    {
                        cmbNameSanad.BackColor = Color.GreenYellow;
                        cmbNameSanad.Properties.Items.Clear();
                        cmbNameSanad.Properties.Items.Add("فاکتور فروش");
                        cmbNameSanad.Properties.Items.Add("فاکتور برگشت از فروش");
                        cmbNameSanad.Properties.Items.Add("سفارش فروش");
                        //cmbNameSanad.Properties.Items.Add("فاکتور فروش خدمات");
                        //cmbNameSanad.Properties.Items.Add("سفارش فروش خدمات");

                        lblNoeSanad.Text = "نوع فروش";
                        cmbNoeSanad.Properties.Items.Clear();
                        cmbNoeSanad.Properties.Items.Add("فروش کالای داخلی");
                        cmbNoeSanad.Properties.Items.Add("فروش کالای صادراتی");

                        cmbNameSanad.SelectedIndex = 0;
                        _NameSanadCode = 201;
                        _NameAmaliatCode = 2;
                        _NoeFactor = 1;
                        lblFNumberJoze_BaNameSanad_BaSelectAnbar.Text = "ش فاکتور جزء";
                        lblFNumberCol_BaNameSanad_BeSelectAnbar.Text = "ش فاکتور کل";

                        lblSefaresh.Visible = cmbSefaresh.Visible = btnRemoveSefaresh.Visible = true;
                    }
                    else if (this.Name == "FrmFactorBargashtAzFroosh")
                    {
                        cmbNameSanad.BackColor = Color.Yellow;
                        cmbNameSanad.Properties.Items.Clear();
                        cmbNameSanad.Properties.Items.Add("فاکتور فروش");
                        cmbNameSanad.Properties.Items.Add("فاکتور برگشت از فروش");
                        cmbNameSanad.Properties.Items.Add("سفارش فروش");
                        //cmbNameSanad.Properties.Items.Add("فاکتور فروش خدمات");
                        //cmbNameSanad.Properties.Items.Add("سفارش فروش خدمات");

                        lblNoeSanad.Text = "نوع برگشت";
                        cmbNoeSanad.Properties.Items.Clear();
                        cmbNoeSanad.Properties.Items.Add("برگشت کالای داخلی");
                        cmbNoeSanad.Properties.Items.Add("برگشت کالای صادراتی");

                        cmbNameSanad.SelectedIndex = 1;
                        _NameSanadCode = 202;
                        _NameAmaliatCode = 2;
                        _NoeFactor = 1;

                        lblFNumberJoze_BaNameSanad_BaSelectAnbar.Text = "ش فاکتور جزء";
                        lblFNumberCol_BaNameSanad_BeSelectAnbar.Text = "ش فاکتور کل";

                        lblSanadMabna.Visible = cmbSanadMabna.Visible = btnRemoveSanadMabna.Visible = true;

                    }
                    else if (this.Name == "FrmSefareshFrooshKala")
                    {
                        cmbNameSanad.BackColor = Color.SkyBlue;
                        cmbNameSanad.Properties.Items.Clear();
                        cmbNameSanad.Properties.Items.Add("فاکتور فروش");
                        cmbNameSanad.Properties.Items.Add("فاکتور برگشت از فروش");
                        cmbNameSanad.Properties.Items.Add("سفارش فروش");
                        //cmbNameSanad.Properties.Items.Add("فاکتور فروش خدمات");
                        //cmbNameSanad.Properties.Items.Add("سفارش فروش خدمات");


                        lblNoeSanad.Text = "نوع سفارش";
                        cmbNoeSanad.Properties.Items.Clear();
                        cmbNoeSanad.Properties.Items.Add("سفارش کالای داخلی");
                        cmbNoeSanad.Properties.Items.Add("سفارش کالای صادراتی");

                        cmbNameSanad.SelectedIndex = 2;
                        _NameSanadCode = 203;
                        _NameAmaliatCode = 2;
                        _NoeFactor = 1;

                        lblFNumberJoze_BaNameSanad_BaSelectAnbar.Text = "ش سفارش جزء";
                        lblFNumberCol_BaNameSanad_BeSelectAnbar.Text = "ش سفارش کل";

                        lblSNumberJoze_BaNameSanad_BaSelectAnbar.Visible = txtSNumberJoze_BaNameSanad_BaSelectAnbar.Visible = false;
                        lblSNumberCol_BaNameSanad_BeSelectAnbar.Visible = txtSNumberCol_BaNameSanad_BeSelectAnbar.Visible = false;
                        lblSabetAtefNumber.Visible = txtSabetAtefNumber.Visible = false;
                        lblGhateySanadNumber.Visible = txtGhateySanadNumber.Visible = false;
                        lblRozaneSanadNumber.Visible = txtRozaneSanadNumber.Visible = false;
                        chkEditCode.Visible = false;

                    }
                    else if (this.Name == "FrmFactorKharidKala")
                    {
                        cmbNameSanad.BackColor = Color.LightCoral;
                        cmbNameSanad.Properties.Items.Clear();
                        cmbNameSanad.Properties.Items.Add("فاکتور خرید");
                        cmbNameSanad.Properties.Items.Add("فاکتور برگشت از خرید");
                        cmbNameSanad.Properties.Items.Add("سفارش خرید");
                        //cmbNameSanad.Properties.Items.Add("فاکتور خرید خدمات");
                        //cmbNameSanad.Properties.Items.Add("سفارش خرید خدمات");


                        lblNoeSanad.Text = "نوع خرید";
                        cmbNoeSanad.Properties.Items.Clear();
                        cmbNoeSanad.Properties.Items.Add("خرید کالای داخلی");
                        cmbNoeSanad.Properties.Items.Add("خرید کالای وارداتی");

                        cmbNameSanad.SelectedIndex = 0;
                        _NameSanadCode = 101;
                        _NameAmaliatCode = 1;
                        _NoeFactor = 1;

                        lblFNumberJoze_BaNameSanad_BaSelectAnbar.Text = "ش فاکتور جزء";
                        lblFNumberCol_BaNameSanad_BeSelectAnbar.Text = "ش فاکتور کل";

                        lblSefaresh.Visible = cmbSefaresh.Visible = btnRemoveSefaresh.Visible = true;

                    }
                    else if (this.Name == "FrmFactorBargashtAzKharid")
                    {
                        cmbNameSanad.BackColor = Color.Cyan;
                        cmbNameSanad.Properties.Items.Clear();
                        cmbNameSanad.Properties.Items.Add("فاکتور خرید");
                        cmbNameSanad.Properties.Items.Add("فاکتور برگشت از خرید");
                        cmbNameSanad.Properties.Items.Add("سفارش خرید");
                        //cmbNameSanad.Properties.Items.Add("فاکتور خرید خدمات");
                        //cmbNameSanad.Properties.Items.Add("سفارش خرید خدمات");


                        lblNoeSanad.Text = "نوع برگشت";
                        cmbNoeSanad.Properties.Items.Clear();
                        cmbNoeSanad.Properties.Items.Add("برگشت کالای داخلی");
                        cmbNoeSanad.Properties.Items.Add("برگشت کالای وارداتی");

                        cmbNameSanad.SelectedIndex = 1;
                        _NameSanadCode = 102;
                        _NameAmaliatCode = 1;
                        _NoeFactor = 1;

                        lblFNumberJoze_BaNameSanad_BaSelectAnbar.Text = "ش فاکتور جزء";
                        lblFNumberCol_BaNameSanad_BeSelectAnbar.Text = "ش فاکتور کل";

                        lblSanadMabna.Visible = cmbSanadMabna.Visible = btnRemoveSanadMabna.Visible = true;
                    }
                    else if (this.Name == "FrmSefareshKharidKala")
                    {
                        cmbNameSanad.BackColor = Color.Pink;
                        cmbNameSanad.Properties.Items.Clear();
                        cmbNameSanad.Properties.Items.Add("فاکتور خرید");
                        cmbNameSanad.Properties.Items.Add("فاکتور برگشت از خرید");
                        cmbNameSanad.Properties.Items.Add("سفارش خرید");
                        //cmbNameSanad.Properties.Items.Add("فاکتور خرید خدمات");
                        //cmbNameSanad.Properties.Items.Add("سفارش خرید خدمات");


                        lblNoeSanad.Text = "نوع سفارش";
                        cmbNoeSanad.Properties.Items.Clear();
                        cmbNoeSanad.Properties.Items.Add("سفارش کالای داخلی");
                        cmbNoeSanad.Properties.Items.Add("سفارش کالای وارداتی");

                        cmbNameSanad.SelectedIndex = 2;
                        _NameSanadCode = 103;
                        _NameAmaliatCode = 1;
                        _NoeFactor = 1;

                        lblFNumberJoze_BaNameSanad_BaSelectAnbar.Text = "ش سفارش جزء";
                        lblFNumberCol_BaNameSanad_BeSelectAnbar.Text = "ش سفارش کل";

                        lblSNumberJoze_BaNameSanad_BaSelectAnbar.Visible = txtSNumberJoze_BaNameSanad_BaSelectAnbar.Visible = false;
                        lblSNumberCol_BaNameSanad_BeSelectAnbar.Visible = txtSNumberCol_BaNameSanad_BeSelectAnbar.Visible = false;
                        lblSabetAtefNumber.Visible = txtSabetAtefNumber.Visible = false;
                        lblGhateySanadNumber.Visible = txtGhateySanadNumber.Visible = false;
                        lblRozaneSanadNumber.Visible = txtRozaneSanadNumber.Visible = false;
                        chkEditCode.Visible = false;

                    }



                    if (En1 == EnumCED.Edit)
                    {
                        var q1 = db.FkAmaliatFrooshVKharid_Rizs.Where(s => s.SalId == _SalId && s.FNumber_BeNameAmaliat_BeSelectAnbar == _FNumber_BeNameAmaliat_BeSelectAnbar && s.FNumberCol_BaNameSanad_BeSelectAnbar == _FNumberCol_BaNameSanad_BeSelectAnbar).ToList();
                        cmbNameSanad.SelectedIndex = q1.FirstOrDefault().NameSanadIndex;
                        //cmbNoeAghlamKala.SelectedIndex = q1.FirstOrDefault().NoeAghlamIndex;
                        //if (q1.FirstOrDefault().SefareshId != null)
                        cmbSefaresh.EditValue = q1.FirstOrDefault().SefareshId;
                        cmbSanadMabna.EditValue = q1.FirstOrDefault().SanadMabnaId;
                        txtFNumberCol_BaNameSanad_BeSelectAnbar.Text = q1.FirstOrDefault().FNumberCol_BaNameSanad_BeSelectAnbar.ToString();
                        if (_FirstSelectAnbar_NextSanad)
                            txtFNumberJoze_BaNameSanad_BaSelectAnbar.Text = q1.FirstOrDefault().FNumberJoze_BaNameSanad_BaSelectAnbar.ToString();
                        txtTarikhSanad.Text = q1.FirstOrDefault().DateTimeSanad.ToString();
                        if (q1.FirstOrDefault().GhateySanadNamber != null)
                            txtGhateySanadNumber.Text = q1.FirstOrDefault().GhateySanadNamber.ToString();
                        //if (q1.FirstOrDefault().SabetAtefNumber > 0)
                        txtSabetAtefNumber.Text = q1.FirstOrDefault().SabetAtefNumber.ToString();
                        // if (q1.FirstOrDefault().SabetAtefNumber > 0)
                        txtRozaneSanadNumber.Text = q1.FirstOrDefault().RozaneSanadNumber.ToString();
                        if (q1.FirstOrDefault().PaygiriNumber != null)
                            txtPaygiriNumber.Text = q1.FirstOrDefault().PaygiriNumber.ToString();
                        if (q1.FirstOrDefault().DateTimePaygiri != null)
                            txtTarikhPaygiri.Text = q1.FirstOrDefault().DateTimePaygiri.ToString();
                        txtSNumberJoze_BaNameSanad_BaSelectAnbar.Text = q1.FirstOrDefault().SNumberCol_BaNameSanad_BeSelectAnbar.ToString();
                        txtSNumberCol_BaNameSanad_BeSelectAnbar.Text = q1.FirstOrDefault().SNumberJoze_BaNameSanad_BaSelectAnbar.ToString();
                        cmbHesabMoin.EditValue = q1.FirstOrDefault().HesabMoinId;
                        cmbHesabTafsili1.EditValue = q1.FirstOrDefault().HesabTafsili1Id;
                        cmbHesabTafsili2.EditValue = q1.FirstOrDefault().HesabTafsili2Id;
                        cmbHesabTafsili3.EditValue = q1.FirstOrDefault().HesabTafsili3Id;
                        if (q1.FirstOrDefault().SharhSanad != null)
                            txtSharhSanad.Text = q1.FirstOrDefault().DateTimePaygiri.ToString();

                        foreach (var item in q1)
                        {
                            item.KalaCode_NM = new MyContext().EpNameKalas.FirstOrDefault(s => s.Id == item.KalaId).Code.ToString();
                            item.KalaName_NM = new MyContext().EpNameKalas.FirstOrDefault(s => s.Id == item.KalaId).Name;
                            item.VahedeKala_NM = new MyContext().EpNameKalas.FirstOrDefault(s => s.Id == item.KalaId).EpVahedAsliKala.Name;
                            item.AnbarName_NM = new MyContext().EpListAnbarhas.FirstOrDefault(s => s.Id == item.AnbarId).Name;
                        }

                        if (!_FirstSelectAnbar_NextSanad)
                        {
                            if (XtraTabControl1.SelectedTabPage == xtp_AghlamKala)
                            {
                                //akVorodeKala_RizsBindingSource.DataSource = dbContext.AKAmaliatAnbarVKala_Rizs.Local.ToBindingList();
                                fkAmaliatFrooshVKharid_RizsBindingSource_Kala.DataSource = q1.Where(s => s.EpNameKala1.EpGroupFareeKala1.EpGroupAsliKala1.EpTabaghehKala1.NoeTabagheIndex == 0).Count() > 0 ? q1.Where(s => s.EpNameKala1.EpGroupFareeKala1.EpGroupAsliKala1.EpTabaghehKala1.NoeTabagheIndex == 0).ToList() : null;
                            }
                            else if (XtraTabControl1.SelectedTabPage == xtp_AghlamKhadamat)
                            {
                                //akVorodeKala_RizsBindingSource.DataSource = dbContext.AKAmaliatAnbarVKala_Rizs.Local.ToBindingList();
                                fkAmaliatFrooshVKharid_RizsBindingSource_Khadamat.DataSource = q1.Where(s => s.EpNameKala1.EpGroupFareeKala1.EpGroupAsliKala1.EpTabaghehKala1.NoeTabagheIndex == 1).Count() > 0 ? q1.Where(s => s.EpNameKala1.EpGroupFareeKala1.EpGroupAsliKala1.EpTabaghehKala1.NoeTabagheIndex == 1).ToList() : null;
                            }
                        }
                        else
                        {
                            if (XtraTabControl1.SelectedTabPage == xtp_AghlamKala)
                            {
                                var q4 = q1.Where(s => s.FNumberJoze_BaNameSanad_BaSelectAnbar == _FNumberJoze_BaNameSanad_BaSelectAnbar).ToList();
                                fkAmaliatFrooshVKharid_RizsBindingSource_Kala.DataSource = q4.Where(s => s.EpNameKala1.EpGroupFareeKala1.EpGroupAsliKala1.EpTabaghehKala1.NoeTabagheIndex == 0).Count() > 0 ? q4.Where(s => s.EpNameKala1.EpGroupFareeKala1.EpGroupAsliKala1.EpTabaghehKala1.NoeTabagheIndex == 0).ToList() : null;
                            }
                            else if (XtraTabControl1.SelectedTabPage == xtp_AghlamKhadamat)
                            {
                                var q4 = q1.Where(s => s.FNumberJoze_BaNameSanad_BaSelectAnbar == _FNumberJoze_BaNameSanad_BaSelectAnbar).ToList();
                                fkAmaliatFrooshVKharid_RizsBindingSource_Khadamat.DataSource = q4.Where(s => s.EpNameKala1.EpGroupFareeKala1.EpGroupAsliKala1.EpTabaghehKala1.NoeTabagheIndex == 1).Count() > 0 ? q4.Where(s => s.EpNameKala1.EpGroupFareeKala1.EpGroupAsliKala1.EpTabaghehKala1.NoeTabagheIndex == 1).ToList() : null;
                            }
                        }
                    }
                }
                catch (Exception ex)
                {
                    XtraMessageBox.Show("عملیات با خطا مواجه شد" + "\n" + ex.Message,
                        "پیغام", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }

            //En1 = EnumCED.None;
            //ActiveButtons();
            //NameAmaliatTabpageIndex = 0;
            //NameAmaliatTabpageName = xtcAmaliatRozaneh.SelectedTabPage.Name;
            //_NameAmaliatCode = 2;
            //_NameSanadCode = 201;
            //// xtcAmaliatRozaneh.SelectedTabPageIndex = 0;
            //NameSanadTabpageIndex = 0;
            //XtraTabControl1_1 = xtc_VorodeKala;
            //NameSanadTabpageName = XtraTabControl1_1.SelectedTabPage.Name;
            //NameSanadText = XtraTabControl1_1.SelectedTabPage.Text;
            //xtcAmaliatRozaneh.SelectedTabPageIndex = 0;
            //gridControl = gridControl_AllVorode;
            //gridView = gridView_AllVorode;
            //xtcAmaliatRozaneh.SelectedTabPageIndex = 0;
            //        xtcAmaliatRozaneh_SelectedPageChanged(null, null);
            //xtc_VorodeKala.SelectedTabPageIndex = 0;
            //objGridControl = new GridControl();
            //objGridControl = gridControl_AllVorode;
            //gridControl_AllVorode.DataBindings.Clear();
            //xtp_ResidJabejaee.Controls.Add(gc);

            // XtraTabControl1_1.SelectedTabPageIndex = 0;
            //FillCmbNameAnbar();
            //textEdit1.Focus();

            //panelControl1_2.Width = 0;
            //panelControl1_2.Height = 364;


        }


        private void btnInsert1_Click(object sender, EventArgs e)
        {
            En2 = EnumCED.Create;
            FrmSelectKala fm = new FrmSelectKala(this);
            if (XtraTabControl1.SelectedTabPage == xtp_AghlamKala)
            {
                fm.gridControl = gridControl_AghlamKala;
                fm.gridView = gridView_AghlamKala;
                //fm.btnInsert = btnInsert1;
            }
            else if (XtraTabControl1.SelectedTabPage == xtp_AghlamKhadamat)
            {
                fm.gridControl = gridControl_AghlamKhadamat;
                fm.gridView = gridView_AghlamKhadamat;

            }

            if (_FirstSelectAnbar_NextSanad)
            {
                fm.AnbarId = _AnbarId = Convert.ToInt32(cmbNameAnbar.EditValue);
                //fm.BeAnbarId  = Convert.ToInt32(cmbBeAnbar.EditValue);
            }

            //fm.MdiParent = this;
            fm.lblUserId.Text = lblUserId.Text;
            fm.lblUserName.Text = lblUserName.Text;
            fm.lblSalId.Text = lblSalId.Text;
            fm.lblSalMali.Text = lblSalMali.Text;
            fm.Text = "ایجاد رکورد جدید";
            fm.ShowDialog();

        }

        private void btnEdit1_Click(object sender, EventArgs e)
        {
            //gridControl1 = new GridControl();
            //gridView1 = new GridView();
            En2 = EnumCED.Edit;
            FrmSelectKala fm = new FrmSelectKala(this);
            if (XtraTabControl1.SelectedTabPage == xtp_AghlamKala)
            {
                fm.gridControl = gridControl_AghlamKala;
                fm.gridView = gridView_AghlamKala;
                fm.btnEdit = btnEdit1;
            }
            else if (XtraTabControl1.SelectedTabPage == xtp_AghlamKhadamat)
            {
                fm.gridControl = gridControl_AghlamKhadamat;
                fm.gridView = gridView_AghlamKhadamat;
                fm.btnEdit = btnEdit1;
            }

            if (gridView1.RowCount > 0)
            {
                _AnbarId = fm.AnbarId = Convert.ToInt32(gridView1.GetFocusedRowCellValue("AnbarId"));
                // _BeAnbarId = fm.BeAnbarId = Convert.ToInt32(gridView1.GetFocusedRowCellValue("BeAnbarId"));
                _KalaId = Convert.ToInt32(gridView1.GetFocusedRowCellValue("KalaId"));
                _VahedeKalaId = Convert.ToInt32(gridView1.GetFocusedRowCellValue("VahedeKalaId"));
                //_KalaCode_NM = gridView_AmaliatAddVaEdit.GetFocusedRowCellDisplayText("KalaCode");
                //_KalaName_NM = gridView_AmaliatAddVaEdit.GetFocusedRowCellDisplayText("KalaName");
                _Meghdar = Convert.ToDecimal(gridView1.GetFocusedRowCellDisplayText("Meghdar"));
                _Nerkh = Convert.ToDecimal(gridView1.GetFocusedRowCellDisplayText("Nerkh"));
                _Mablag = Convert.ToDecimal(gridView1.GetFocusedRowCellDisplayText("Mablag"));
                _Tozihat = gridView1.GetFocusedRowCellDisplayText("Tozihat");
                _RowHandle = gridView1.FocusedRowHandle;

                //fm.MdiParent = this;
                fm.lblUserId.Text = lblUserId.Text;
                fm.lblUserName.Text = lblUserName.Text;
                fm.lblSalId.Text = lblSalId.Text;
                fm.lblSalMali.Text = lblSalMali.Text;
                //fm.AzAnbarId = Convert.ToInt32(cmbNameAnbar.EditValue);
                fm.ShowDialog();

            }

        }

        private void gridView_CustomDrawRowIndicator(object sender, DevExpress.XtraGrid.Views.Grid.RowIndicatorCustomDrawEventArgs e)
        {
            GridView view = sender as GridView;
            HelpClass1.CustomDrawRowIndicator(sender, e, view);

        }

        public void FillCmbHesabMoin()
        {
            using (var db = new MyContext())
            {
                try
                {
                    _SalId = Convert.ToInt32(lblSalId.Text);
                    var q = db.EpHesabMoin1s.Where(s => s.SalId == _SalId).OrderBy(s => s.Code).ToList();
                    if (En1 == EnumCED.Edit)
                        cmbHesabMoin.Properties.DataSource = q.Count > 0 ? q : null;
                    else
                        cmbHesabMoin.Properties.DataSource = q.Where(s => s.IsActive == true).ToList().Count > 0 ? q.Where(s => s.IsActive == true).ToList() : null;
                }
                catch (Exception ex)
                {
                    XtraMessageBox.Show("عملیات با خطا مواجه شد" + "\n" + ex.Message,
                        "پیغام", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
        }

        public void FillCmbHesabTafsili()
        {
            using (var db = new MyContext())
            {
                try
                {
                    _SalId = Convert.ToInt32(lblSalId.Text);
                    _HesabMoinId = Convert.ToInt32(cmbHesabMoin.EditValue);

                    List<EpAllHesabTafsili> list = new List<EpAllHesabTafsili>();

                    var q1 = db.R_EpHesabMoin1_B_EpAllGroupTafsilis.Where(s => s.EpHesabMoin1Id == _HesabMoinId && s.SalId == _SalId).Select(s => s.AllGroupTafsiliId).ToList();
                    if (q1.Count > 0)
                    {
                        foreach (var item in q1)
                        {
                            var q = db.EpAllHesabTafsilis.Where(s => s.SalId == _SalId && s.GroupTafsiliId == item).OrderBy(s => s.Code).ToList();
                            list.AddRange(q);
                        }
                        #region MyRegion
                        ////db.EpAllHesabTafsilis.AddRange(list);
                        //List<EpAllHesabTafsili_HesabMovaghat> list1 = new List<EpAllHesabTafsili_HesabMovaghat>();
                        //foreach (var item in list)
                        //{
                        //    EpAllHesabTafsili_HesabMovaghat obj = new EpAllHesabTafsili_HesabMovaghat();
                        //    obj.Id = item.Id;
                        //    obj.SalId = item.SalId;
                        //    obj.LevelNumber = item.LevelNumber;
                        //    obj.Code = item.Code;
                        //    obj.Name = item.Name;
                        //    obj.GroupTafsiliId = item.GroupTafsiliId;
                        //    obj.MoinId = _HesabMoinId;
                        //    obj.IsActive = item.IsActive;
                        //    obj.IsDefault = item.IsDefault;
                        //    obj.SharhHesab = item.SharhHesab;
                        //    list1.Add(obj);
                        //}
                        //db.EpAllHesabTafsili_HesabMovaghats.AddRange(list1);

                        ////BindingSource bs = new BindingSource();
                        ////bs.DataSource = list;
                        ////BindingList<EpAllHesabTafsili> ok = new BindingList<EpAllHesabTafsili>(list);
                        //db.EpAllHesabTafsili_HesabMovaghats.Load(); 
                        #endregion
                        if (En1 == EnumCED.Create)
                        {
                            cmbHesabTafsili1.Properties.DataSource = list.Where(s => s.IsActive == true && s.LevelNumber == 1).Count() > 0 ? list.Where(s => s.IsActive == true && s.LevelNumber == 1).OrderBy(s => s.Code).ToList() : null;
                            cmbHesabTafsili2.Properties.DataSource = list.Where(s => s.IsActive == true && s.LevelNumber == 2).Count() > 0 ? list.Where(s => s.IsActive == true && s.LevelNumber == 2).OrderBy(s => s.Code).ToList() : null;
                            cmbHesabTafsili3.Properties.DataSource = list.Where(s => s.IsActive == true && s.LevelNumber == 3).Count() > 0 ? list.Where(s => s.IsActive == true && s.LevelNumber == 3).OrderBy(s => s.Code).ToList() : null;

                        }
                        else
                        {
                            cmbHesabTafsili1.Properties.DataSource = list.Where(s => s.LevelNumber == 1).OrderBy(s => s.Code);
                            cmbHesabTafsili2.Properties.DataSource = list.Where(s => s.LevelNumber == 2).OrderBy(s => s.Code);
                            cmbHesabTafsili3.Properties.DataSource = list.Where(s => s.LevelNumber == 3).OrderBy(s => s.Code);
                        }
                    }
                    else
                    {
                        cmbHesabTafsili1.Properties.DataSource = null;
                        cmbHesabTafsili2.Properties.DataSource = null;
                        cmbHesabTafsili3.Properties.DataSource = null;

                    }

                    //if (_HesabMoinId == 14)
                    //{
                    //    cmbHesabTafsili.Properties.DataSource = db.EpAllHesabTafsilis.Where(s => s.GroupTafsiliId == 1 || s.GroupTafsiliId == 2).ToList();
                    //}
                    //else if (_HesabMoinId == 15)
                    //{
                    //    cmbHesabTafsili.Properties.DataSource = db.EpAllHesabTafsilis.Where(s => s.GroupTafsiliId == 3 || s.GroupTafsiliId == 4).ToList();
                    //}

                }
                catch (Exception ex)
                {
                    XtraMessageBox.Show("عملیات با خطا مواجه شد" + "\n" + ex.Message,
                        "پیغام", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
        }

        private void gridView_InitNewRow(object sender, InitNewRowEventArgs e)
        {
            //GridView view = sender as GridView;
            //int a = gridView1.RowCount - 1;
            gridView1.SetRowCellValue(e.RowHandle, "AnbarId", _AnbarId);
            //gridView1.SetRowCellValue(e.RowHandle, "BeAnbarId", _BeAnbarId);
            gridView1.SetRowCellValue(e.RowHandle, "KalaId", _KalaId);
            gridView1.SetRowCellValue(e.RowHandle, "VahedeKalaId", _VahedeKalaId);
            gridView1.SetRowCellValue(e.RowHandle, "KalaCode_NM", _KalaCode_NM);
            gridView1.SetRowCellValue(e.RowHandle, "KalaName_NM", _KalaName_NM);
            gridView1.SetRowCellValue(e.RowHandle, "VahedeKala_NM", _VahedeKala_NM);
            gridView1.SetRowCellValue(e.RowHandle, "AnbarName_NM", _AnbarName_NM);
            //gridView1.SetRowCellValue(e.RowHandle, "BeAnbarName_NM", _BeAnbarName_NM);
            gridView1.SetRowCellValue(e.RowHandle, "Meghdar", _Meghdar);
            gridView1.SetRowCellValue(e.RowHandle, "Nerkh", _Nerkh);
            gridView1.SetRowCellValue(e.RowHandle, "Mablag", _Mablag);
            gridView1.SetRowCellValue(e.RowHandle, "Tozihat", _Tozihat);

            // gridView_AmaliatAddVaEdit.AddNewRow();

        }

        private void gridView_RowCellClick(object sender, RowCellClickEventArgs e)
        {
            btnDelete1.Enabled = btnEdit1.Enabled = true;
        }

        private void gridView_RowCountChanged(object sender, EventArgs e)
        {
            if (gridView1 != null)
            {
                if (gridView1.RowCount > 0)
                {
                    btnDelete1.Enabled = btnEdit1.Enabled = true;
                    btnSaveAndClosed.Enabled = btnSaveAndNext.Enabled = btnSaveAndPrintAndClosed.Enabled = true;

                    if (_FirstSelectAnbar_NextSanad)
                    {
                        panelControl_NameAnbar.Enabled = false;
                    }

                }
                else
                {
                    btnDelete1.Enabled = btnEdit1.Enabled = false;
                    btnSaveAndClosed.Enabled = btnSaveAndNext.Enabled = btnSaveAndPrintAndClosed.Enabled = false;
                    if (_FirstSelectAnbar_NextSanad)
                    {
                        panelControl_NameAnbar.Enabled = true;
                    }
                }

            }
        }

        private void XtraTabControl1_SelectedPageChanged(object sender, DevExpress.XtraTab.TabPageChangedEventArgs e)
        {
            try
            {
                btnDelete1.Enabled = btnEdit1.Enabled = false;
                if (XtraTabControl1.SelectedTabPage == xtp_AghlamKala)
                {
                    gridControl1 = gridControl_AghlamKala;
                    gridView1 = gridView_AghlamKala;
                }
                else if (XtraTabControl1.SelectedTabPage == xtp_AghlamKhadamat)
                {
                    gridControl1 = gridControl_AghlamKhadamat;
                    gridView1 = gridView_AghlamKhadamat;
                }
            }
            catch (Exception)
            {
            }

        }

        private void gridView_KeyDown(object sender, KeyEventArgs e)
        {
            gridView_RowCellClick(null, null);
        }

        private void gridView_KeyUp(object sender, KeyEventArgs e)
        {
            gridView_RowCellClick(null, null);

        }


        public bool IsValidation()
        {
            // string s = txtMeghdar.Text.Trim();
            if (cmbNameSanad.SelectedIndex < 0 || cmbNameSanad.Text == "" || string.IsNullOrEmpty(cmbNameSanad.Text))
            {
                //xtpAmaliatAddVEdit.Text = NameSanad + " : نوع سند " + ": " + cmbNameSanad.Text;
                XtraMessageBox.Show("نوع سند مشخص نیست", "پیغام", MessageBoxButtons.OK, MessageBoxIcon.Information);
                //cmbNameSanad.ShowPopup();
                return false;
            }
            else if (Convert.ToInt32(cmbNameAnbar.EditValue) == 0 && _FirstSelectAnbar_NextSanad && gridView_AghlamKala.RowCount > 0)
            {
                XtraMessageBox.Show("لطفاً انبار را مشخص کنید", "پیغام", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                cmbNameAnbar.Focus();
                return false;
            }
            else if (Convert.ToInt32(cmbHesabMoin.EditValue) == 0)
            {
                XtraMessageBox.Show("لطفاً " + lblHesabMoin.Text + " را انتخاب کنید", "پیغام", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                cmbHesabMoin.Focus();
                return false;
            }
            else if (Convert.ToInt32(cmbHesabTafsili1.EditValue) == 0 && cmbHesabTafsili1.ReadOnly == false)
            {
                XtraMessageBox.Show("لطفاً " + lblHesabTafsili1.Text + " را انتخاب کنید", "پیغام", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                cmbHesabTafsili1.Focus();
                return false;
            }
            else if (Convert.ToInt32(cmbHesabTafsili2.EditValue) == 0 && cmbHesabTafsili2.ReadOnly == false)
            {
                XtraMessageBox.Show("لطفاً " + lblHesabTafsili2.Text + " را انتخاب کنید", "پیغام", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                cmbHesabTafsili2.Focus();
                return false;
            }
            else if (Convert.ToInt32(cmbHesabTafsili3.EditValue) == 0 && cmbHesabTafsili3.ReadOnly == false)
            {
                XtraMessageBox.Show("لطفاً " + lblHesabTafsili3.Text + " را انتخاب کنید", "پیغام", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                cmbHesabTafsili3.Focus();
                return false;
            }
            //else if (cmbNoeAghlamKala.SelectedIndex < 0)
            //{
            //    XtraMessageBox.Show("لطفاً " + lblHesabTafsili3.Text + " را مشخص کنید", "پیغام", MessageBoxButtons.OK, MessageBoxIcon.Warning);
            //    cmbNoeAghlamKala.Focus();
            //    return false;
            //}
            else if (string.IsNullOrEmpty(txtFNumberCol_BaNameSanad_BeSelectAnbar.Text))
            {
                XtraMessageBox.Show("فیلد " + lblFNumberCol_BaNameSanad_BeSelectAnbar + " خالی است ", "پیغام", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                txtFNumberCol_BaNameSanad_BeSelectAnbar.Focus();
                return false;
            }
            else if (string.IsNullOrEmpty(txtFNumberJoze_BaNameSanad_BaSelectAnbar.Text) && _FirstSelectAnbar_NextSanad == true)
            {
                XtraMessageBox.Show("فیلد " + lblFNumberJoze_BaNameSanad_BaSelectAnbar + " خالی است ", "پیغام", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                txtFNumberJoze_BaNameSanad_BaSelectAnbar.Focus();
                return false;
            }
            else if (string.IsNullOrEmpty(txtRozaneSanadNumber.Text))
            {
                XtraMessageBox.Show("فیلد " + lblRozaneSanadNumber + " خالی است", "پیغام", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                txtRozaneSanadNumber.Focus();
                return false;
            }
            else if (string.IsNullOrEmpty(cmbNoeSanad.Text))
            {
                XtraMessageBox.Show("لطفاً " + cmbNoeSanad + " را مشخص کنید", "پیغام", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                cmbNoeSanad.Focus();
                return false;
            }
            else if (string.IsNullOrEmpty(txtTarikhSanad.Text))
            {
                XtraMessageBox.Show("لطفاً تاریخ را وارد کنید", "پیغام", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                txtTarikhSanad.Focus();
                return false;
            }
            else if (gridView_AghlamKala.RowCount == 0 && _NoeFactor == 1)
            {
                XtraMessageBox.Show("در قسمت اقلام کالا اطلاعاتی برای ذخیره وجود ندارد", "پیغام", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                XtraTabControl1.SelectedTabPage = xtp_AghlamKala;
                btnInsert1.Focus();
                return false;
            }
            else if (gridView_AghlamKhadamat.RowCount == 0 && _NoeFactor == 2)
            {
                XtraMessageBox.Show("در قسمت اقلام خدمات اطلاعاتی برای ذخیره وجود ندارد", "پیغام", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                XtraTabControl1.SelectedTabPage = xtp_AghlamKhadamat;
                btnInsert1.Focus();
                return false;
            }
            return true;
        }

        private void btnSaveAndClosed_Click(object sender, EventArgs e)
        {
            if (btnSaveAndClosed.Enabled)
            {
                using (var db = new MyContext())
                {
                    try
                    {
                        if (IsValidation())
                        {
                            _SalId = Convert.ToInt32(lblSalId.Text);

                            DateTime? _DateTimePaygiri = null;
                            if (!string.IsNullOrEmpty(txtTarikhPaygiri.Text))
                                _DateTimePaygiri = Convert.ToDateTime(txtTarikhPaygiri.Text);
                            DateTime _DateTimeSanad = Convert.ToDateTime(txtTarikhSanad.Text);
                            DateTime _DateTimeInsert = DateTime.Now;
                            _NameSanadIndex = Convert.ToInt32(cmbNameSanad.SelectedIndex);
                            _NameSanadText = cmbNameSanad.Text;
                            int? _GhateySanadNamber = null;
                            int _SabetAtefNumber = 0;
                            int _RozaneSanadNumber = Convert.ToInt32(txtRozaneSanadNumber.Text);
                            int? _PaygiriNumber = null;
                            if (txtPaygiriNumber.Text != "")
                                _PaygiriNumber = Convert.ToInt32(txtPaygiriNumber.Text);
                            _SharhSanad = txtSharhSanad.Text;
                            _SefareshId = Convert.ToInt32(cmbSefaresh.EditValue);

                            //_NoeAghlamText = cmbNoeAghlamKala.Text;
                            //_NoeAghlamIndex = Convert.ToInt32(cmbNoeAghlamKala.SelectedIndex);
                            //_FNumberCol_BaNameSanad_BeSelectAnbar = Convert.ToInt32(txtFNumberCol_BaNameSanad_BeSelectAnbar.Text);
                            //_FNumberJoze_BaNameSanad_BaSelectAnbar = Convert.ToInt32(txtFNumberJoze_BaNameSanad_BaSelectAnbar.Text);

                            _HesabMoinId = Convert.ToInt32(cmbHesabMoin.EditValue);
                            _HesabTafsili1Id = Convert.ToInt32(cmbHesabTafsili1.EditValue) == 0 ? db.EpAllHesabTafsilis.FirstOrDefault(s => s.SalId == _SalId && s.LevelNumber == 1 && s.EpAllGroupTafsili1.Id == 19 && s.Name == "سایر 1").Id : Convert.ToInt32(cmbHesabTafsili1.EditValue);
                            _HesabTafsili2Id = Convert.ToInt32(cmbHesabTafsili2.EditValue) == 0 ? db.EpAllHesabTafsilis.FirstOrDefault(s => s.SalId == _SalId && s.LevelNumber == 2 && s.EpAllGroupTafsili1.Id == 38 && s.Name == "سایر 2").Id : Convert.ToInt32(cmbHesabTafsili2.EditValue);
                            _HesabTafsili3Id = Convert.ToInt32(cmbHesabTafsili3.EditValue) == 0 ? db.EpAllHesabTafsilis.FirstOrDefault(s => s.SalId == _SalId && s.LevelNumber == 3 && s.EpAllGroupTafsili1.Id == 57 && s.Name == "سایر 3").Id : Convert.ToInt32(cmbHesabTafsili3.EditValue);


                            if (En1 == EnumCED.Create)
                            {
                                //var qq = db.EpNameKalas.Where(s => s.SalId == _SalId);
                                var qp1 = db.FkAmaliatFrooshVKharid_Rizs.Where(s => s.SalId == _SalId).ToList();
                                _FNumber_BeNameAmaliat_BeSelectAnbar = qp1.Select(s => s.FNumber_BeNameAmaliat_BeSelectAnbar).ToList().Count > 0 ? qp1.Max(s => s.FNumber_BeNameAmaliat_BeSelectAnbar) + 1 : 1;
                                _FNumber_BaNameAmaliat_BeSelectAnbar = qp1.Where(s => s.NameAmaliatCode == _NameAmaliatCode).Select(s => s.FNumber_BaNameAmaliat_BeSelectAnbar).ToList().Count > 0 ? qp1.Where(s => s.NameAmaliatCode == _NameAmaliatCode).Max(s => s.FNumber_BaNameAmaliat_BeSelectAnbar) + 1 : 1;
                                _FNumberCol_BaNameSanad_BeSelectAnbar = qp1.Where(s => s.NameAmaliatCode == _NameAmaliatCode && s.NameSanadCode == _NameSanadCode).Select(s => s.FNumberCol_BaNameSanad_BeSelectAnbar).ToList().Count > 0 ? qp1.Where(s => s.NameAmaliatCode == _NameAmaliatCode && s.NameSanadCode == _NameSanadCode).Max(s => s.FNumberCol_BaNameSanad_BeSelectAnbar) + 1 : 1;
                                _FNumberJoze_BaNameSanad_BaNoeFactor = qp1.Where(s => s.NameAmaliatCode == _NameAmaliatCode && s.NameSanadCode == _NameSanadCode && s.NoeFactor == _NoeFactor).Select(s => s.FNumberJoze_BaNameSanad_BaNoeFactor).ToList().Count > 0 ? qp1.Where(s => s.NameAmaliatCode == _NameAmaliatCode && s.NameSanadCode == _NameSanadCode && s.NoeFactor == _NoeFactor).Max(s => s.FNumberJoze_BaNameSanad_BaNoeFactor) + 1 : 1;

                                //var qp3 = qp1.Where(s => s.NameAmaliatCode == _NameAmaliatCode).ToList();
                                //_SeryalCol_BaNameAmaliat_BeSelectAnbar = qp3.Count > 0 ? qp3.Max(s => s.SeryalCol_BaNameAmaliat_BeSelectAnbar) + 1 : 1;

                                //var qp4 = qp3.Where(s => s.NameSanadCode == _NameSanadCode).ToList();
                                //_SeryalJoze_BaNameSanad_BeSelectAnbar = qp4.Count > 0 ? qp4.Max(s => s.SeryalJoze_BaNameSanad_BeSelectAnbar) + 1 : 1;


                                List<FkAmaliatFrooshVKharid_Riz> list = new List<FkAmaliatFrooshVKharid_Riz>();
                                ///////////////   اقلام کالا  /////////////**************************************************
                                if (gridView_AghlamKala.RowCount > 0 && _NoeFactor == 1)
                                {
                                    _NoeSanadIndex = Convert.ToInt32(cmbNoeSanad.SelectedIndex);
                                    _NoeSanadText = cmbNoeSanad.SelectedText;
                                    _SanadMabnaId = Convert.ToInt32(cmbSanadMabna.EditValue);

                                    if (_FirstSelectAnbar_NextSanad)
                                    {
                                        _AnbarId = Convert.ToInt32(cmbNameAnbar.EditValue);
                                        var qp2 = db.FkAmaliatFrooshVKharid_Rizs.Where(s => s.SalId == _SalId && s.NameAmaliatCode == _NameAmaliatCode && s.AnbarId == _AnbarId).ToList();
                                        _FNumber_BaNameAmaliat_BaSelectAnbar = qp2.Count > 0 ? qp2.Max(s => s.FNumber_BaNameAmaliat_BaSelectAnbar) + 1 : 1;
                                        _FNumberJoze_BaNameSanad_BaSelectAnbar = qp2.Where(s => s.NameSanadCode == _NameSanadCode).Select(s => s.FNumberJoze_BaNameSanad_BaSelectAnbar).ToList().Count > 0 ? qp2.Where(s => s.NameSanadCode == _NameSanadCode).Max(s => s.FNumberJoze_BaNameSanad_BaSelectAnbar) + 1 : 1;
                                    }

                                    for (int i = 0; i < gridView_AghlamKala.RowCount; i++)
                                    {
                                        //if (!_FirstSelectAnbar_NextSanad)
                                        //{
                                        //    _AnbarId = Convert.ToInt32(gridView_AghlamKala.GetRowCellValue(i, "AnbarId"));
                                        //    var qp2 = db.FkAmaliatFrooshVKharid_Rizs.Where(s => s.SalId == _SalId && s.NameAmaliatCode == _NameAmaliatCode && s.AnbarId == _AnbarId).ToList();
                                        //    _FNumber_BaNameAmaliat_BaSelectAnbar = qp2.Count > 0 ? qp2.Max(s => s.FNumber_BaNameAmaliat_BaSelectAnbar) + 1 : 1;
                                        //    _FNumberJoze_BaNameSanad_BaSelectAnbar = qp2.Where(s => s.NameSanadCode == _NameSanadCode).Select(s => s.FNumberJoze_BaNameSanad_BaSelectAnbar).ToList().Count > 0 ? qp2.Where(s => s.NameSanadCode == _NameSanadCode).Max(s => s.FNumberJoze_BaNameSanad_BaSelectAnbar) + 1 : 1;

                                        //    //var qq1 = q.Where(s => s.NameSanadCode == _NameSanadCode).ToList();
                                        //    //_SeryalJoze_BaNameSanad_BaSelectAnbar = qq1.Count > 0 ? qq1.Max(s => s.SeryalJoze_BaNameSanad_BaSelectAnbar) + 1 : 1;
                                        //}

                                        _AnbarId = Convert.ToInt32(gridView_AghlamKala.GetRowCellValue(i, "AnbarId"));
                                        _KalaId = Convert.ToInt32(gridView_AghlamKala.GetRowCellValue(i, "KalaId"));
                                        _VahedeKalaId = Convert.ToInt32(gridView_AghlamKala.GetRowCellValue(i, "VahedeKalaId"));
                                        //long _Code = Convert.ToInt64(gridView_AmaliatAddVaEdit.GetRowCellValue(i, "KalaCode_NM"));
                                        _Meghdar = Convert.ToDecimal(gridView_AghlamKala.GetRowCellValue(i, "Meghdar"));
                                        _Nerkh = Convert.ToDecimal(gridView_AghlamKala.GetRowCellValue(i, "Nerkh"));
                                        _Mablag = Convert.ToDecimal(gridView_AghlamKala.GetRowCellValue(i, "Mablag"));
                                        _Tozihat = gridView_AghlamKala.GetRowCellValue(i, "Tozihat") != null ? gridView_AghlamKala.GetRowCellValue(i, "Tozihat").ToString() : null;

                                        FkAmaliatFrooshVKharid_Riz obj1 = new FkAmaliatFrooshVKharid_Riz();
                                        obj1.SalId = _SalId;
                                        obj1.FNumber_BeNameAmaliat_BeSelectAnbar = _FNumber_BeNameAmaliat_BeSelectAnbar;
                                        obj1.FNumber_BaNameAmaliat_BeSelectAnbar = _FNumber_BaNameAmaliat_BeSelectAnbar;
                                        obj1.FNumberCol_BaNameSanad_BeSelectAnbar = _FNumberCol_BaNameSanad_BeSelectAnbar;
                                        obj1.FNumber_BaNameAmaliat_BaSelectAnbar = _FNumber_BaNameAmaliat_BaSelectAnbar;
                                        obj1.FNumberJoze_BaNameSanad_BaSelectAnbar = _FNumberJoze_BaNameSanad_BaSelectAnbar;
                                        obj1.FNumberJoze_BaNameSanad_BaNoeFactor = _FNumberJoze_BaNameSanad_BaNoeFactor;
                                        obj1.AnbarId = _AnbarId;
                                        obj1.KalaId = _KalaId;
                                        obj1.VahedeKalaId = _VahedeKalaId;
                                        obj1.SNumber_BeNameAmaliat_BeSelectAnbar = _SNumber_BeNameAmaliat_BeSelectAnbar;
                                        obj1.SNumber_BaNameAmaliat_BeSelectAnbar = _SNumber_BaNameAmaliat_BeSelectAnbar;
                                        obj1.SNumberCol_BaNameSanad_BeSelectAnbar = _SNumberCol_BaNameSanad_BeSelectAnbar;
                                        obj1.SNumber_BaNameAmaliat_BaSelectAnbar = _SNumber_BaNameAmaliat_BaSelectAnbar;
                                        obj1.SNumberJoze_BaNameSanad_BaSelectAnbar = _SNumberJoze_BaNameSanad_BaSelectAnbar;
                                        obj1.GhateySanadNamber = _GhateySanadNamber;
                                        obj1.SabetAtefNumber = _SabetAtefNumber;
                                        obj1.RozaneSanadNumber = _RozaneSanadNumber;
                                        obj1.PaygiriNumber = _PaygiriNumber;
                                        obj1.DateTimePaygiri = _DateTimePaygiri;
                                        obj1.DateTimeSanad = _DateTimeSanad;
                                        obj1.DateTimeInsert = _DateTimeInsert;
                                        obj1.NoeFactor = _NoeFactor;
                                        obj1.NameAmaliatCode = _NameAmaliatCode;
                                        obj1.NameSanadCode = _NameSanadCode;
                                        obj1.NameSanadText = _NameSanadText;
                                        obj1.NameSanadIndex = _NameSanadIndex;
                                        obj1.NoeSanadIndex = _NoeSanadIndex;
                                        obj1.NoeSanadText = _NoeSanadText;
                                        obj1.SefareshId = Convert.ToInt32(cmbSefaresh.EditValue);
                                        obj1.SanadMabnaId = Convert.ToInt32(cmbSanadMabna.EditValue);
                                        obj1.Meghdar = _Meghdar;
                                        obj1.Nerkh = _Nerkh;
                                        obj1.Mablag = _Mablag;
                                        obj1.IsRiali = _Mablag > 0 ? true : false;
                                        obj1.Radif = i + 1;
                                        obj1.Tozihat = _Tozihat;
                                        obj1.SharhSanad = _SharhSanad;
                                        obj1.HesabMoinId = _HesabMoinId;
                                        obj1.HesabTafsili1Id = _HesabTafsili1Id;
                                        obj1.HesabTafsili2Id = _HesabTafsili2Id;
                                        obj1.HesabTafsili3Id = _HesabTafsili3Id;
                                        list.Add(obj1);

                                    }
                                }
                                /////////////// اقلام خدمات /////////////***************************************************
                                if (gridView_AghlamKhadamat.RowCount > 0)
                                {
                                    _AnbarId = 0;
                                    _SanadMabnaId = 0;
                                    _FNumber_BaNameAmaliat_BaSelectAnbar = 0;
                                    _FNumberJoze_BaNameSanad_BaSelectAnbar = 0;

                                    if (_NoeFactor == 1)
                                    {
                                        _NoeSanadIndex = -1;
                                        _NoeSanadText = "";

                                    }
                                    else if (_NoeFactor == 2)
                                    {
                                        _NoeSanadIndex = Convert.ToInt32(cmbNoeSanad.SelectedIndex);
                                        _NoeSanadText = cmbNoeSanad.SelectedText;

                                    }
                                    for (int i = 0; i < gridView_AghlamKhadamat.RowCount; i++)
                                    {
                                        _KalaId = Convert.ToInt32(gridView_AghlamKhadamat.GetRowCellValue(i, "KalaId"));
                                        _VahedeKalaId = Convert.ToInt32(gridView_AghlamKhadamat.GetRowCellValue(i, "VahedeKalaId"));
                                        _Meghdar = Convert.ToDecimal(gridView_AghlamKhadamat.GetRowCellValue(i, "Meghdar"));
                                        _Nerkh = Convert.ToDecimal(gridView_AghlamKhadamat.GetRowCellValue(i, "Nerkh"));
                                        _Mablag = Convert.ToDecimal(gridView_AghlamKhadamat.GetRowCellValue(i, "Mablag"));
                                        _Tozihat = gridView_AghlamKhadamat.GetRowCellValue(i, "Tozihat") != null ? gridView_AghlamKhadamat.GetRowCellValue(i, "Tozihat").ToString() : null;

                                        FkAmaliatFrooshVKharid_Riz obj1 = new FkAmaliatFrooshVKharid_Riz();
                                        obj1.SalId = _SalId;
                                        obj1.FNumber_BeNameAmaliat_BeSelectAnbar = _FNumber_BeNameAmaliat_BeSelectAnbar;
                                        obj1.FNumber_BaNameAmaliat_BeSelectAnbar = _FNumber_BaNameAmaliat_BeSelectAnbar;
                                        obj1.FNumberCol_BaNameSanad_BeSelectAnbar = _FNumberCol_BaNameSanad_BeSelectAnbar;
                                        obj1.FNumber_BaNameAmaliat_BaSelectAnbar = _FNumber_BaNameAmaliat_BaSelectAnbar;
                                        obj1.FNumberJoze_BaNameSanad_BaSelectAnbar = _FNumberJoze_BaNameSanad_BaSelectAnbar;
                                        obj1.FNumberJoze_BaNameSanad_BaNoeFactor = _FNumberJoze_BaNameSanad_BaNoeFactor;
                                        obj1.AnbarId = _AnbarId;
                                        obj1.KalaId = _KalaId;
                                        obj1.VahedeKalaId = _VahedeKalaId;
                                        obj1.SNumber_BeNameAmaliat_BeSelectAnbar = _SNumber_BeNameAmaliat_BeSelectAnbar;
                                        obj1.SNumber_BaNameAmaliat_BeSelectAnbar = _SNumber_BaNameAmaliat_BeSelectAnbar;
                                        obj1.SNumberCol_BaNameSanad_BeSelectAnbar = _SNumberCol_BaNameSanad_BeSelectAnbar;
                                        obj1.SNumber_BaNameAmaliat_BaSelectAnbar = _SNumber_BaNameAmaliat_BaSelectAnbar;
                                        obj1.SNumberJoze_BaNameSanad_BaSelectAnbar = _SNumberJoze_BaNameSanad_BaSelectAnbar;
                                        obj1.GhateySanadNamber = _GhateySanadNamber;
                                        obj1.SabetAtefNumber = _SabetAtefNumber;
                                        obj1.RozaneSanadNumber = _RozaneSanadNumber;
                                        obj1.PaygiriNumber = _PaygiriNumber;
                                        obj1.DateTimePaygiri = _DateTimePaygiri;
                                        obj1.DateTimeSanad = _DateTimeSanad;
                                        obj1.DateTimeInsert = _DateTimeInsert;
                                        obj1.NoeFactor = _NoeFactor;
                                        obj1.NameAmaliatCode = _NameAmaliatCode;
                                        obj1.NameSanadCode = _NameSanadCode;
                                        obj1.NameSanadText = _NameSanadText;
                                        obj1.NameSanadIndex = _NameSanadIndex;
                                        obj1.NoeSanadIndex = _NoeSanadIndex;
                                        obj1.NoeSanadText = _NoeSanadText;
                                        obj1.SefareshId = _SefareshId;
                                        obj1.SanadMabnaId = _SanadMabnaId;
                                        obj1.Meghdar = _Meghdar;
                                        obj1.Nerkh = _Nerkh;
                                        obj1.Mablag = _Mablag;
                                        obj1.IsRiali = _Mablag > 0 ? true : false;
                                        obj1.Radif = i + 1;
                                        obj1.Tozihat = _Tozihat;
                                        obj1.SharhSanad = _SharhSanad;
                                        obj1.HesabMoinId = _HesabMoinId;
                                        obj1.HesabTafsili1Id = _HesabTafsili1Id;
                                        obj1.HesabTafsili2Id = _HesabTafsili2Id;
                                        obj1.HesabTafsili3Id = _HesabTafsili3Id;
                                        list.Add(obj1);

                                    }
                                }

                                db.FkAmaliatFrooshVKharid_Rizs.AddRange(list);
                                db.SaveChanges();
                                En1 = EnumCED.Save;
                                if (sender == btnSaveAndClosed)
                                    this.Close();
                                //else if (sender == btnSaveAndNext)
                                //btnCancel_Click(null, null);


                            }
                            else if (En1 == EnumCED.Edit)
                            {
                                _SalId = Convert.ToInt32(lblSalId.Text);
                                DateTime _DateTimeEdit = DateTime.Now;

                                ///////////////   اقلام کالا  /////////////////////////////////////////**********************
                                if (gridView_AghlamKala.RowCount > 0 && _NoeFactor == 1)
                                {
                                    _NoeSanadIndex = Convert.ToInt32(cmbNoeSanad.SelectedIndex);
                                    _NoeSanadText = cmbNoeSanad.SelectedText;
                                    _SanadMabnaId = Convert.ToInt32(cmbSanadMabna.EditValue);

                                    List<FkAmaliatFrooshVKharid_Riz> DBGridControl = (List<FkAmaliatFrooshVKharid_Riz>)fkAmaliatFrooshVKharid_RizsBindingSource_Kala.DataSource;
                                    BindingList<FkAmaliatFrooshVKharid_Riz> list = new BindingList<FkAmaliatFrooshVKharid_Riz>(DBGridControl);

                                    List<FkAmaliatFrooshVKharid_Riz> q2 = new List<FkAmaliatFrooshVKharid_Riz>();
                                    if (_FirstSelectAnbar_NextSanad)
                                    {
                                        _AnbarId = Convert.ToInt32(cmbNameAnbar.EditValue);
                                        var qq2 = db.FkAmaliatFrooshVKharid_Rizs.Where(s => s.SalId == _SalId && s.AnbarId == _AnbarId && s.NameAmaliatCode == _NameAmaliatCode && s.NameSanadCode == _NameSanadCode
                                        && s.FNumberJoze_BaNameSanad_BaSelectAnbar == _FNumberJoze_BaNameSanad_BaSelectAnbar && s.FNumberJoze_BaNameSanad_BaNoeFactor == _FNumberJoze_BaNameSanad_BaNoeFactor).ToList();
                                        foreach (var item in qq2)
                                        {
                                            if (!list.Any(s => s.Id == item.Id))
                                            {
                                                db.FkAmaliatFrooshVKharid_Rizs.Remove(qq2.FirstOrDefault(s => s.Id == item.Id));
                                                db.SaveChanges();
                                            }
                                        }
                                        q2 = qq2;
                                    }
                                    else
                                    {
                                        var qq2 = db.FkAmaliatFrooshVKharid_Rizs.Where(s => s.SalId == _SalId && s.AnbarId != 0 && s.NameAmaliatCode == _NameAmaliatCode && s.NameSanadCode == _NameSanadCode
                                        && s.FNumberCol_BaNameSanad_BeSelectAnbar == _FNumberCol_BaNameSanad_BeSelectAnbar && s.FNumberJoze_BaNameSanad_BaNoeFactor == _FNumberJoze_BaNameSanad_BaNoeFactor).ToList();
                                        foreach (var item in qq2)
                                        {
                                            if (!list.Any(s => s.Id == item.Id))
                                            {
                                                db.FkAmaliatFrooshVKharid_Rizs.Remove(qq2.FirstOrDefault(s => s.Id == item.Id));
                                                db.SaveChanges();
                                            }
                                        }
                                        q2 = qq2;
                                    }


                                    //var q = db.FkAmaliatFrooshVKharid_Rizs.Where(s => s.SalId == _SalId).ToList();
                                    for (int i = 0; i < list.Count; i++)
                                    {
                                        //if (!_FirstSelectAnbar_NextSanad)
                                        //{
                                        //    _AnbarId = Convert.ToInt32(gridView_AghlamKala.GetRowCellValue(i, "AnbarId"));

                                        //    var pp1 = q.Where(s => s.AnbarId == _AnbarId).ToList();
                                        //    //var ss1 = q2.FirstOrDefault(s => s.BeAnbarId == _BeAnbarId);
                                        //    //_SeryalCol_BeNameAmaliat_BaSelectAnbar = ss1 != null ? ss1.SeryalCol_BeNameAmaliat_BaSelectAnbar : pp1.Count > 0 ? pp1.Max(s => s.SeryalCol_BeNameAmaliat_BaSelectAnbar) + 1 : 1;

                                        //    var pp2 = pp1.Where(s => s.NameAmaliatCode == _NameAmaliatCode).ToList();
                                        //    var ss2 = q2.FirstOrDefault(s => s.NameAmaliatCode == _NameAmaliatCode && s.AnbarId == _AnbarId);
                                        //    _FNumber_BaNameAmaliat_BaSelectAnbar = ss2 != null ? ss2.FNumber_BaNameAmaliat_BaSelectAnbar : pp2.Count > 0 ? pp2.Max(s => s.FNumber_BaNameAmaliat_BaSelectAnbar) + 1 : 1;

                                        //    var pp3 = pp2.Where(s => s.NameSanadCode == _NameSanadCode).ToList();
                                        //    var ss3 = q2.FirstOrDefault(s => s.NameAmaliatCode == _NameAmaliatCode && s.NameSanadCode == _NameSanadCode && s.AnbarId == _AnbarId);
                                        //    _FNumberJoze_BaNameSanad_BaSelectAnbar = ss3 != null ? ss3.FNumberJoze_BaNameSanad_BaSelectAnbar : pp3.Count > 0 ? pp3.Max(s => s.FNumberJoze_BaNameSanad_BaSelectAnbar) + 1 : 1;
                                        //}

                                        _AnbarId = Convert.ToInt32(gridView_AghlamKala.GetRowCellValue(i, "AnbarId"));
                                        _KalaId = Convert.ToInt32(gridView_AghlamKala.GetRowCellValue(i, "KalaId"));
                                        _VahedeKalaId = Convert.ToInt32(gridView_AghlamKala.GetRowCellValue(i, "VahedeKalaId"));
                                        //long _Code = Convert.ToInt64(gridView_AmaliatAddVaEdit.GetRowCellValue(i, "KalaCode_NM"));
                                        _Meghdar = Convert.ToDecimal(gridView_AghlamKala.GetRowCellValue(i, "Meghdar"));
                                        _Nerkh = Convert.ToDecimal(gridView_AghlamKala.GetRowCellValue(i, "Nerkh"));
                                        _Mablag = Convert.ToDecimal(gridView_AghlamKala.GetRowCellValue(i, "Mablag"));
                                        _Tozihat = gridView_AghlamKala.GetRowCellValue(i, "Tozihat") != null ? gridView_AghlamKala.GetRowCellValue(i, "Tozihat").ToString() : null;

                                        if (list[i].Id > 0)
                                        {

                                            var v1 = q2.FirstOrDefault(s =>  s.Id == list[i].Id);

                                            //v1.SalId = _SalId;
                                            v1.AnbarId = _AnbarId;
                                            v1.FNumber_BaNameAmaliat_BaSelectAnbar = _FNumber_BaNameAmaliat_BaSelectAnbar;
                                            v1.FNumberJoze_BaNameSanad_BaSelectAnbar = _FNumberJoze_BaNameSanad_BaSelectAnbar;
                                            v1.SNumber_BaNameAmaliat_BaSelectAnbar = _SNumber_BaNameAmaliat_BaSelectAnbar;
                                            v1.SNumberJoze_BaNameSanad_BaSelectAnbar = _SNumberJoze_BaNameSanad_BaSelectAnbar;
                                            v1.RozaneSanadNumber = _RozaneSanadNumber;
                                            v1.PaygiriNumber = _PaygiriNumber;
                                            v1.KalaId = _KalaId;
                                            v1.VahedeKalaId = _VahedeKalaId;
                                            v1.DateTimePaygiri = _DateTimePaygiri;
                                            v1.DateTimeSanad = _DateTimeSanad;
                                            v1.DateTimeEdit = _DateTimeEdit;
                                            //v1.NameAmaliatCode = _NameAmaliatCode;
                                            //v1.NameSanadCode = _NameSanadCode;
                                            //v1.NameSanadText = _NameSanadText;
                                            //v1.NameSanadIndex = _NameSanadIndex;
                                            v1.NoeSanadIndex = _NoeSanadIndex;
                                            v1.NoeSanadText = _NoeSanadText;
                                            v1.SefareshId = _SefareshId;
                                            v1.SanadMabnaId = _SanadMabnaId;
                                            v1.Meghdar = _Meghdar;
                                            v1.Nerkh = _Nerkh;
                                            v1.Mablag = _Mablag;
                                            v1.IsRiali = _Mablag > 0 ? true : false;
                                            v1.Tozihat = _Tozihat;
                                            v1.SharhSanad = _SharhSanad;
                                            v1.HesabMoinId = _HesabMoinId;
                                            v1.HesabTafsili1Id = _HesabTafsili1Id;
                                            v1.HesabTafsili2Id = _HesabTafsili2Id;
                                            v1.HesabTafsili3Id = _HesabTafsili3Id;

                                            db.SaveChanges();
                                        }
                                        else
                                        {

                                            FkAmaliatFrooshVKharid_Riz obj1 = new FkAmaliatFrooshVKharid_Riz();
                                            obj1.SalId = _SalId;
                                            obj1.FNumber_BeNameAmaliat_BeSelectAnbar = _FNumber_BeNameAmaliat_BeSelectAnbar;
                                            obj1.FNumber_BaNameAmaliat_BeSelectAnbar = _FNumber_BaNameAmaliat_BeSelectAnbar;
                                            obj1.FNumberCol_BaNameSanad_BeSelectAnbar = _FNumberCol_BaNameSanad_BeSelectAnbar;
                                            obj1.FNumber_BaNameAmaliat_BaSelectAnbar = _FNumber_BaNameAmaliat_BaSelectAnbar;
                                            obj1.FNumberJoze_BaNameSanad_BaSelectAnbar = _FNumberJoze_BaNameSanad_BaSelectAnbar;
                                            obj1.FNumberJoze_BaNameSanad_BaNoeFactor = _FNumberJoze_BaNameSanad_BaNoeFactor;
                                            obj1.AnbarId = _AnbarId;
                                            obj1.KalaId = _KalaId;
                                            obj1.VahedeKalaId = _VahedeKalaId;
                                            obj1.SNumber_BeNameAmaliat_BeSelectAnbar = _SNumber_BeNameAmaliat_BeSelectAnbar;
                                            obj1.SNumber_BaNameAmaliat_BeSelectAnbar = _SNumber_BaNameAmaliat_BeSelectAnbar;
                                            obj1.SNumberCol_BaNameSanad_BeSelectAnbar = _SNumberCol_BaNameSanad_BeSelectAnbar;
                                            obj1.SNumber_BaNameAmaliat_BaSelectAnbar = _SNumber_BaNameAmaliat_BaSelectAnbar;
                                            obj1.SNumberJoze_BaNameSanad_BaSelectAnbar = _SNumberJoze_BaNameSanad_BaSelectAnbar;
                                            obj1.GhateySanadNamber = _GhateySanadNamber;
                                            obj1.SabetAtefNumber = _SabetAtefNumber;
                                            obj1.RozaneSanadNumber = _RozaneSanadNumber;
                                            obj1.PaygiriNumber = _PaygiriNumber;
                                            obj1.DateTimePaygiri = _DateTimePaygiri;
                                            obj1.DateTimeSanad = _DateTimeSanad;
                                            obj1.DateTimeInsert = _DateTimeInsert;
                                            obj1.NameAmaliatCode = _NameAmaliatCode;
                                            obj1.NameSanadCode = _NameSanadCode;
                                            obj1.NameSanadText = _NameSanadText;
                                            obj1.NameSanadIndex = _NameSanadIndex;
                                            obj1.NoeSanadIndex = _NoeSanadIndex;
                                            obj1.NoeSanadText = _NoeSanadText;
                                            obj1.SefareshId = _SefareshId;
                                            obj1.SanadMabnaId = _SanadMabnaId;
                                            obj1.Meghdar = _Meghdar;
                                            obj1.Nerkh = _Nerkh;
                                            obj1.Mablag = _Mablag;
                                            obj1.IsRiali = _Mablag > 0 ? true : false;
                                            obj1.Radif = i + 1;
                                            obj1.Tozihat = _Tozihat;
                                            obj1.SharhSanad = _SharhSanad;
                                            //if (!string.IsNullOrEmpty(cmbSefaresh.Text))
                                            //obj1.SefareshId = Convert.ToInt32(cmbSefaresh.EditValue);
                                            //obj1.RozaneSanadNumber = _RozaneSanadNumber;
                                            //obj1.PaygiriNumber = _PaygiriNumber;
                                            obj1.HesabMoinId = _HesabMoinId;
                                            obj1.HesabTafsili1Id = _HesabTafsili1Id;
                                            obj1.HesabTafsili2Id = _HesabTafsili2Id;
                                            obj1.HesabTafsili3Id = _HesabTafsili3Id;


                                            db.FkAmaliatFrooshVKharid_Rizs.Add(obj1);
                                            db.SaveChanges();
                                        }
                                    }
                                    var qq1 = db.FkAmaliatFrooshVKharid_Rizs.Where(s => s.SalId == _SalId && s.AnbarId != 0 && s.NameAmaliatCode == _NameAmaliatCode && s.NameSanadCode == _NameSanadCode
                                    && s.FNumberCol_BaNameSanad_BeSelectAnbar == _FNumberCol_BaNameSanad_BeSelectAnbar && s.FNumberJoze_BaNameSanad_BaNoeFactor == _FNumberJoze_BaNameSanad_BaNoeFactor).ToList();
                                    if (qq1.Count > 0)
                                    {
                                        for (int j = 0; j < qq1.Count; j++)
                                        {
                                            qq1[j].Radif = j + 1;
                                        }
                                        db.SaveChanges();
                                    }

                                }
                                /////////////// اقلام خدمات //////////////////////////////////////////**********************
                                if (gridView_AghlamKhadamat.RowCount > 0 )
                                {
                                    _AnbarId = 0;
                                    _SanadMabnaId = 0;
                                    _FNumber_BaNameAmaliat_BaSelectAnbar = 0;
                                    _FNumberJoze_BaNameSanad_BaSelectAnbar = 0;

                                    if (_NoeFactor == 1)
                                    {
                                        _NoeSanadIndex = -1;
                                        _NoeSanadText = "";

                                    }
                                    else if (_NoeFactor == 2)
                                    {
                                        _NoeSanadIndex = Convert.ToInt32(cmbNoeSanad.SelectedIndex);
                                        _NoeSanadText = cmbNoeSanad.SelectedText;

                                    }

                                    List<FkAmaliatFrooshVKharid_Riz> DBGridControl = (List<FkAmaliatFrooshVKharid_Riz>)fkAmaliatFrooshVKharid_RizsBindingSource_Khadamat.DataSource;
                                    BindingList<FkAmaliatFrooshVKharid_Riz> list = new BindingList<FkAmaliatFrooshVKharid_Riz>(DBGridControl);

                                    //List<FkAmaliatFrooshVKharid_Riz> q2 = new List<FkAmaliatFrooshVKharid_Riz>();

                                    var q2 = db.FkAmaliatFrooshVKharid_Rizs.Where(s => s.SalId == _SalId && s.AnbarId == 0 && s.NameAmaliatCode == _NameAmaliatCode && s.NameSanadCode == _NameSanadCode
                                    && s.FNumberCol_BaNameSanad_BeSelectAnbar == _FNumberCol_BaNameSanad_BeSelectAnbar && s.FNumberJoze_BaNameSanad_BaNoeFactor== _FNumberJoze_BaNameSanad_BaNoeFactor).ToList();
                                    foreach (var item in q2)
                                    {
                                        if (!list.Any(s => s.Id == item.Id))
                                        {
                                            db.FkAmaliatFrooshVKharid_Rizs.Remove(q2.FirstOrDefault(s => s.Id == item.Id));
                                            db.SaveChanges();
                                        }
                                    }


                                    //var q = db.FkAmaliatFrooshVKharid_Rizs.Where(s => s.SalId == _SalId).ToList();
                                    for (int i = 0; i < list.Count; i++)
                                    {
                                        //if (!_FirstSelectAnbar_NextSanad)
                                        //{
                                        //    _AnbarId = Convert.ToInt32(gridView_AghlamKhadamat.GetRowCellValue(i, "AnbarId"));

                                        //    var pp1 = q.Where(s => s.AnbarId == _AnbarId).ToList();
                                        //    //var ss1 = q2.FirstOrDefault(s => s.BeAnbarId == _BeAnbarId);
                                        //    //_SeryalCol_BeNameAmaliat_BaSelectAnbar = ss1 != null ? ss1.SeryalCol_BeNameAmaliat_BaSelectAnbar : pp1.Count > 0 ? pp1.Max(s => s.SeryalCol_BeNameAmaliat_BaSelectAnbar) + 1 : 1;

                                        //    var pp2 = pp1.Where(s => s.NameAmaliatCode == _NameAmaliatCode).ToList();
                                        //    var ss2 = q2.FirstOrDefault(s => s.NameAmaliatCode == _NameAmaliatCode && s.AnbarId == _AnbarId);
                                        //    _FNumber_BaNameAmaliat_BaSelectAnbar = ss2 != null ? ss2.FNumber_BaNameAmaliat_BaSelectAnbar : pp2.Count > 0 ? pp2.Max(s => s.FNumber_BaNameAmaliat_BaSelectAnbar) + 1 : 1;

                                        //    var pp3 = pp2.Where(s => s.NameSanadCode == _NameSanadCode).ToList();
                                        //    var ss3 = q2.FirstOrDefault(s => s.NameAmaliatCode == _NameAmaliatCode && s.NameSanadCode == _NameSanadCode && s.AnbarId == _AnbarId);
                                        //    _FNumberJoze_BaNameSanad_BaSelectAnbar = ss3 != null ? ss3.FNumberJoze_BaNameSanad_BaSelectAnbar : pp3.Count > 0 ? pp3.Max(s => s.FNumberJoze_BaNameSanad_BaSelectAnbar) + 1 : 1;
                                        //}

                                        _KalaId = Convert.ToInt32(gridView_AghlamKhadamat.GetRowCellValue(i, "KalaId"));
                                        _VahedeKalaId = Convert.ToInt32(gridView_AghlamKhadamat.GetRowCellValue(i, "VahedeKalaId"));
                                        //long _Code = Convert.ToInt64(gridView_AmaliatAddVaEdit.GetRowCellValue(i, "KalaCode_NM"));
                                        _Meghdar = Convert.ToDecimal(gridView_AghlamKhadamat.GetRowCellValue(i, "Meghdar"));
                                        _Nerkh = Convert.ToDecimal(gridView_AghlamKhadamat.GetRowCellValue(i, "Nerkh"));
                                        _Mablag = Convert.ToDecimal(gridView_AghlamKhadamat.GetRowCellValue(i, "Mablag"));
                                        _Tozihat = gridView_AghlamKhadamat.GetRowCellValue(i, "Tozihat") != null ? gridView_AghlamKhadamat.GetRowCellValue(i, "Tozihat").ToString() : null;

                                        if (list[i].Id > 0)
                                        {

                                            var v1 = q2.FirstOrDefault(s => s.Id == list[i].Id);

                                            //v1.SalId = _SalId;
                                            //v1.AnbarId = _AnbarId;
                                            //v1.FNumber_BaNameAmaliat_BaSelectAnbar = _FNumber_BaNameAmaliat_BaSelectAnbar;
                                            //v1.FNumberJoze_BaNameSanad_BaSelectAnbar = _FNumberJoze_BaNameSanad_BaSelectAnbar;
                                            //v1.SNumber_BaNameAmaliat_BaSelectAnbar = _SNumber_BaNameAmaliat_BaSelectAnbar;
                                            //v1.SNumberJoze_BaNameSanad_BaSelectAnbar = _SNumberJoze_BaNameSanad_BaSelectAnbar;
                                            v1.RozaneSanadNumber = _RozaneSanadNumber;
                                            v1.PaygiriNumber = _PaygiriNumber;
                                            v1.KalaId = _KalaId;
                                            v1.VahedeKalaId = _VahedeKalaId;
                                            v1.DateTimePaygiri = _DateTimePaygiri;
                                            v1.DateTimeSanad = _DateTimeSanad;
                                            v1.DateTimeEdit = _DateTimeEdit;
                                            //v1.NameAmaliatCode = _NameAmaliatCode;
                                            //v1.NameSanadCode = _NameSanadCode;
                                            //v1.NameSanadText = _NameSanadText;
                                            //v1.NameSanadIndex = _NameSanadIndex;
                                            v1.NoeSanadIndex = _NoeSanadIndex;
                                            v1.NoeSanadText = _NoeSanadText;
                                            v1.SefareshId = _SefareshId;
                                            v1.SanadMabnaId = _SanadMabnaId;
                                            v1.Meghdar = _Meghdar;
                                            v1.Nerkh = _Nerkh;
                                            v1.Mablag = _Mablag;
                                            v1.IsRiali = _Mablag > 0 ? true : false;
                                            v1.Tozihat = _Tozihat;
                                            v1.SharhSanad = _SharhSanad;
                                            v1.HesabMoinId = _HesabMoinId;
                                            v1.HesabTafsili1Id = _HesabTafsili1Id;
                                            v1.HesabTafsili2Id = _HesabTafsili2Id;
                                            v1.HesabTafsili3Id = _HesabTafsili3Id;

                                            db.SaveChanges();
                                        }
                                        else
                                        {

                                            FkAmaliatFrooshVKharid_Riz obj1 = new FkAmaliatFrooshVKharid_Riz();
                                            obj1.SalId = _SalId;
                                            obj1.FNumber_BeNameAmaliat_BeSelectAnbar = _FNumber_BeNameAmaliat_BeSelectAnbar;
                                            obj1.FNumber_BaNameAmaliat_BeSelectAnbar = _FNumber_BaNameAmaliat_BeSelectAnbar;
                                            obj1.FNumberCol_BaNameSanad_BeSelectAnbar = _FNumberCol_BaNameSanad_BeSelectAnbar;
                                            obj1.FNumber_BaNameAmaliat_BaSelectAnbar = _FNumber_BaNameAmaliat_BaSelectAnbar;
                                            obj1.FNumberJoze_BaNameSanad_BaSelectAnbar = _FNumberJoze_BaNameSanad_BaSelectAnbar;
                                            obj1.FNumberJoze_BaNameSanad_BaNoeFactor = _FNumberJoze_BaNameSanad_BaNoeFactor;
                                            obj1.AnbarId = _AnbarId;
                                            obj1.KalaId = _KalaId;
                                            obj1.VahedeKalaId = _VahedeKalaId;
                                            obj1.SNumber_BeNameAmaliat_BeSelectAnbar = _SNumber_BeNameAmaliat_BeSelectAnbar;
                                            obj1.SNumber_BaNameAmaliat_BeSelectAnbar = _SNumber_BaNameAmaliat_BeSelectAnbar;
                                            obj1.SNumberCol_BaNameSanad_BeSelectAnbar = _SNumberCol_BaNameSanad_BeSelectAnbar;
                                            obj1.SNumber_BaNameAmaliat_BaSelectAnbar = _SNumber_BaNameAmaliat_BaSelectAnbar;
                                            obj1.SNumberJoze_BaNameSanad_BaSelectAnbar = _SNumberJoze_BaNameSanad_BaSelectAnbar;
                                            obj1.GhateySanadNamber = _GhateySanadNamber;
                                            obj1.SabetAtefNumber = _SabetAtefNumber;
                                            obj1.RozaneSanadNumber = _RozaneSanadNumber;
                                            obj1.PaygiriNumber = _PaygiriNumber;
                                            obj1.DateTimePaygiri = _DateTimePaygiri;
                                            obj1.DateTimeSanad = _DateTimeSanad;
                                            obj1.DateTimeInsert = _DateTimeInsert;
                                            obj1.NameAmaliatCode = _NameAmaliatCode;
                                            obj1.NameSanadCode = _NameSanadCode;
                                            obj1.NameSanadText = _NameSanadText;
                                            obj1.NameSanadIndex = _NameSanadIndex;
                                            obj1.NoeSanadIndex = _NoeSanadIndex;
                                            obj1.NoeSanadText = _NoeSanadText;
                                            obj1.SefareshId = _SefareshId;
                                            obj1.SanadMabnaId = _SanadMabnaId;
                                            obj1.Meghdar = _Meghdar;
                                            obj1.Nerkh = _Nerkh;
                                            obj1.Mablag = _Mablag;
                                            obj1.IsRiali = _Mablag > 0 ? true : false;
                                            obj1.Radif = i + 1;
                                            obj1.Tozihat = _Tozihat;
                                            obj1.SharhSanad = _SharhSanad;
                                            //if (!string.IsNullOrEmpty(cmbSefaresh.Text))
                                            //obj1.SefareshId = Convert.ToInt32(cmbSefaresh.EditValue);
                                            //obj1.RozaneSanadNumber = _RozaneSanadNumber;
                                            //obj1.PaygiriNumber = _PaygiriNumber;
                                            obj1.HesabMoinId = _HesabMoinId;
                                            obj1.HesabTafsili1Id = _HesabTafsili1Id;
                                            obj1.HesabTafsili2Id = _HesabTafsili2Id;
                                            obj1.HesabTafsili3Id = _HesabTafsili3Id;


                                            db.FkAmaliatFrooshVKharid_Rizs.Add(obj1);
                                            db.SaveChanges();
                                        }
                                    }
                                    var qq1 = db.FkAmaliatFrooshVKharid_Rizs.Where(s => s.SalId == _SalId && s.AnbarId != 0 && s.NameAmaliatCode == _NameAmaliatCode && s.NameSanadCode == _NameSanadCode
                                    && s.FNumberCol_BaNameSanad_BeSelectAnbar == _FNumberCol_BaNameSanad_BeSelectAnbar && s.FNumberJoze_BaNameSanad_BaNoeFactor == _FNumberJoze_BaNameSanad_BaNoeFactor).ToList();
                                    if (qq1.Count > 0)
                                    {
                                        for (int j = 0; j < qq1.Count; j++)
                                        {
                                            qq1[j].Radif = j + 1;
                                        }
                                        db.SaveChanges();
                                    }

                                }
                            }

                            En1 = EnumCED.Save;
                            if (sender == btnSaveAndClosed)
                                this.Close();
                            //else if (sender == btnSaveAndNext)
                            //btnCancel_Click(null, null);
                        }

                    }
                    catch (Exception ex)
                    {
                        XtraMessageBox.Show("عملیات با خطا مواجه شد" + "\n" + ex.ToString(),
                            "پیغام", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    }
                }

            }

        }

        private void cmbSefaresh_Enter(object sender, EventArgs e)
        {
            //if (En1 == EnumCED.Create)
            //    cmbSefaresh.ShowPopup();

        }

        private void cmbNameSanad_SelectedIndexChanged(object sender, EventArgs e)
        {
            FillCmbHesabMoin();
            HelpClass1.DateTimeMask(txtTarikhSanad);
            txtTarikhSanad.Text = DateTime.Now.ToString();

            using (var db = new MyContext())
            {
                try
                {
                    _NameSanadIndex = cmbNameSanad.SelectedIndex;
                    //_NameSanadText = cmbNameSanad.Text;
                    //xtpAmaliatAddVEdit.Text = titelAmaliatAddVEdit + " : " + "نوع سند" + " : " + _NameSanadText;
                    if (cmbNameSanad.SelectedIndex < 0 || cmbNameSanad.Text == "" || string.IsNullOrEmpty(cmbNameSanad.Text))
                    {
                        if (En1 == EnumCED.Create)
                        {

                            XtraMessageBox.Show("نوع سند مشخص نیست", "پیغام", MessageBoxButtons.OK, MessageBoxIcon.Information);
                            //cmbNameSanad.ShowPopup();
                            return;
                        }

                    }

                    //switch (cmbNameSanad.SelectedIndex)
                    //{
                    //    case 0:
                    //        _NameSanadCode = 201;
                    //        _NameAmaliatCode = 2;
                    //        break;
                    //    case 1:
                    //        _NameSanadCode = 202;
                    //        _NameAmaliatCode = 2;
                    //        break;
                    //    case 2:
                    //        _NameSanadCode = 203;
                    //        _NameAmaliatCode = 2;
                    //        break;
                    //    case 3:
                    //        _NameSanadCode = 204;
                    //        _NameAmaliatCode = 2;
                    //        break;
                    //    case 4:
                    //        _NameSanadCode = 101;
                    //        _NameAmaliatCode = 1;
                    //        break;
                    //    case 5:
                    //        _NameSanadCode = 102;
                    //        _NameAmaliatCode = 1;
                    //        break;
                    //    case 6:
                    //        _NameSanadCode = 103;
                    //        _NameAmaliatCode = 1;
                    //        break;
                    //    case 7:
                    //        _NameSanadCode = 104;
                    //        _NameAmaliatCode = 1;
                    //        break;
                    //}


                    if (En1 == EnumCED.Create)
                    {
                        var qp = db.FkAmaliatFrooshVKharid_Rizs.Where(s => s.SalId == _SalId && s.NameAmaliatCode == _NameAmaliatCode && s.NameSanadCode == _NameSanadCode).ToList();
                        txtFNumberCol_BaNameSanad_BeSelectAnbar.Text = qp.Count > 0 ? (qp.Max(s => s.FNumberCol_BaNameSanad_BeSelectAnbar) + 1).ToString() : "1";
                        if (_FirstSelectAnbar_NextSanad)
                        {
                            var qq = qp.Where(s => s.AnbarId == _AnbarId).ToList();
                            txtFNumberJoze_BaNameSanad_BaSelectAnbar.Text = qq.Count > 0 ? (qq.Max(s => s.FNumberJoze_BaNameSanad_BaSelectAnbar) + 1).ToString() : "1";
                        }

                    }
                }
                catch (Exception ex)
                {
                    XtraMessageBox.Show("عملیات با خطا مواجه شد" + "\n" + ex.Message,
                        "پیغام", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }


        }

        private void btnReloadHesabMoin_Click(object sender, EventArgs e)
        {
            FillCmbHesabMoin();

        }

        private void cmbHesabMoin_EditValueChanged(object sender, EventArgs e)
        {
            using (var db = new MyContext())
            {
                try
                {
                    FillCmbHesabTafsili();
                    _SalId = Convert.ToInt32(lblSalId.Text);
                    int _HesabMoinId = Convert.ToInt32(cmbHesabMoin.EditValue);
                    var q = db.EpHesabMoin1s.FirstOrDefault(s => s.SalId == _SalId && s.Id == _HesabMoinId);
                    if (q != null)
                    {
                        switch (q.GroupTafsiliLevelsIndex)
                        {
                            case 0:
                                {
                                    cmbHesabTafsili1.ReadOnly = cmbHesabTafsili2.ReadOnly = cmbHesabTafsili3.ReadOnly = true;
                                    break;
                                }
                            case 1:
                                {
                                    cmbHesabTafsili1.ReadOnly = false;
                                    cmbHesabTafsili2.ReadOnly = cmbHesabTafsili3.ReadOnly = true;
                                    break;
                                }
                            case 2:
                                {
                                    cmbHesabTafsili1.ReadOnly = cmbHesabTafsili2.ReadOnly = false;
                                    cmbHesabTafsili3.ReadOnly = true;
                                    break;
                                }
                            case 3:
                                {
                                    cmbHesabTafsili1.ReadOnly = cmbHesabTafsili2.ReadOnly = cmbHesabTafsili3.ReadOnly = false;
                                    break;
                                }
                            default:
                                break;
                        }

                    }

                    if (Convert.ToInt32(cmbHesabMoin.EditValue) > 0)
                    {
                        btnInsert1.Enabled = true;
                    }
                    else
                    {
                        btnInsert1.Enabled = false;
                    }

                }
                catch (Exception ex)
                {
                    XtraMessageBox.Show("عملیات با خطا مواجه شد" + "\n" + ex.Message,
                        "پیغام", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
        }

        private void FrmFactor_Shown(object sender, EventArgs e)
        {
            if (_FirstSelectAnbar_NextSanad && panelControl_NameAnbar.Enabled == true)
            {
                cmbNameAnbar.Focus();
            }
            else
            {
                cmbNoeSanad.Focus();
            }


        }

        private void btnDelete1_Click(object sender, EventArgs e)
        {
            if (XtraTabControl1.SelectedTabPage == xtp_AghlamKala)
            {
                gridControl1 = gridControl_AghlamKala;
                gridView1 = gridView_AghlamKala;
            }
            else if (XtraTabControl1.SelectedTabPage == xtp_AghlamKala)
            {
                gridControl1 = gridControl_AghlamKhadamat;
                gridView1 = gridView_AghlamKhadamat;
            }


            if (gridView1.RowCount > 0)
            {
                if (XtraMessageBox.Show("آیا ردیف انتخابی حذف گردد؟", "پیغام حذف", MessageBoxButtons.YesNo, MessageBoxIcon.Information) == DialogResult.Yes)
                {
                    //gridView_AmaliatAddVaEdit.DeleteSelectedRows();
                    gridView1.DeleteRow(gridView1.FocusedRowHandle);
                }
            }

        }

        private void cmbHesabMoin_Enter(object sender, EventArgs e)
        {
            if (En1 == EnumCED.Create)
            {
                cmbHesabMoin.ShowPopup();
            }
        }

        bool _IsActiveRow = true;

        private void cmbControl_CustomDrawCell(object sender, DevExpress.XtraEditors.Popup.LookUpCustomDrawCellArgs e)
        {
            if (!_IsActiveRow)
                e.Appearance.ForeColor = Color.Red;

            if (e.Header.Caption == "فعال" && e.DisplayText == "True")
                e.DisplayText = "بله";
            if (e.Header.Caption == "فعال" && e.DisplayText == "False")
                e.DisplayText = "خیر";
            if (e.Header.Caption == "اجازه موجودی منفی" && e.DisplayText == "True")
                e.DisplayText = "بله";
            if (e.Header.Caption == "اجازه موجودی منفی" && e.DisplayText == "False")
                e.DisplayText = "خیر";

        }

        private void cmbControl_CustomDrawRow(object sender, DevExpress.XtraEditors.Popup.LookUpCustomDrawRowArgs e)
        {
            _IsActiveRow = Convert.ToBoolean(e.GetCellValue(0));

        }

        private void cmbHesabTafsili1_Enter(object sender, EventArgs e)
        {
            if (En1 == EnumCED.Create)
            {
                cmbHesabTafsili1.ShowPopup();
            }
        }

        private void cmbHesabTafsili2_Enter(object sender, EventArgs e)
        {
            if (En1 == EnumCED.Create)
            {
                cmbHesabTafsili2.ShowPopup();
            }

        }

        private void cmbHesabTafsili3_Enter(object sender, EventArgs e)
        {
            if (En1 == EnumCED.Create)
            {
                cmbHesabTafsili3.ShowPopup();
            }

        }

        //private void cmbNameAnbar_CustomDrawCell(object sender, DevExpress.XtraEditors.Popup.LookUpCustomDrawCellArgs e)
        //{
        //    if (!_IsActiveRow)
        //        e.Appearance.ForeColor = Color.Red;

        //    if (e.Header.Caption == "فعال" && e.DisplayText == "True")
        //        e.DisplayText = "بله";
        //    if (e.Header.Caption == "فعال" && e.DisplayText == "False")
        //        e.DisplayText = "خیر";
        //    if (e.Header.Caption == "اجازه موجودی منفی" && e.DisplayText == "True")
        //        e.DisplayText = "بله";
        //    if (e.Header.Caption == "اجازه موجودی منفی" && e.DisplayText == "False")
        //        e.DisplayText = "خیر";

        //}

        //private void cmbNameAnbar_CustomDrawRow(object sender, DevExpress.XtraEditors.Popup.LookUpCustomDrawRowArgs e)
        //{
        //    _IsActiveRow = Convert.ToBoolean(e.GetCellValue(0));

        //}

        private void btnReloadNameAnbar_Click(object sender, EventArgs e)
        {
            FillCmbAnbarName();

        }

        private void btnClose_Click(object sender, EventArgs e)
        {
            if (gridView1.RowCount > 0)
            {
                if (XtraMessageBox.Show("آیا اطلاعات ذخیره گردد؟", "پیغام خروج", MessageBoxButtons.YesNo, MessageBoxIcon.Information) == DialogResult.No)
                {
                    this.Close();
                }
                else
                {
                    btnSaveAndClosed_Click(null, null);
                }
            }
            else
                this.Close();

        }

        private void btnSaveAndPrintAndClosed_Click(object sender, EventArgs e)
        {
            if (btnSaveAndPrintAndClosed.Enabled)
            {
                btnSaveAndClosed_Click(null, null);

            }

        }

        private void btnRemoveNoe_Click(object sender, EventArgs e)
        {
            cmbNoeSanad.SelectedIndex = -1;
        }

        private void btnRemoveSefaresh_Click(object sender, EventArgs e)
        {
            cmbSefaresh.EditValue = 0;
        }

        private void btnRemoveSanadMabna_Click(object sender, EventArgs e)
        {
            cmbSanadMabna.EditValue = 0;
        }

        private void cmbNoe_Enter(object sender, EventArgs e)
        {
            if (En1 == EnumCED.Create && cmbNoeSanad.SelectedIndex == -1)
                cmbNoeSanad.ShowPopup();
        }

        private void cmbSanadMabna_Enter(object sender, EventArgs e)
        {
            //if (En1 == EnumCED.Create && string.IsNullOrEmpty(cmbSanadMabna.Text))
            //    cmbSanadMabna.ShowPopup();

        }

        private void cmbNameAnbar_Enter(object sender, EventArgs e)
        {
            if (En1 == EnumCED.Create)
                cmbNameAnbar.ShowPopup();
        }

        private void cmbNameAnbar_EditValueChanged(object sender, EventArgs e)
        {
            cmbNoeSanad.Focus();
        }

        private void txtSharhSanad_Leave(object sender, EventArgs e)
        {
            if (Convert.ToInt32(cmbHesabMoin.EditValue) == 0)
                //btnInsert1.Focus();
                //else
                cmbHesabMoin.Focus();

        }
    }
}