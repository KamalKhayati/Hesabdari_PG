/****************************** Ghost.github.io ******************************\
*	Module Name:	FrmAccesslevel2.cs
*	Project:		SystemManagement
*	Copyright (C) 2018 Kamal Khayati, All rights reserved.
*	This software may be modified and distributed under the terms of the MIT license.  See LICENSE file for details.
*
*	Written by Kamal Khayati <Kamal1355@gmail.com>,  2019 / 1 / 20   10:46 AM
*	
***********************************************************************************/
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Text;
using System.Linq;
using System.Threading.Tasks;
using System.Windows.Forms;
using DevExpress.XtraEditors;
using System.Data.Entity;
using DBHesabdari_TG;
using DevExpress.XtraEditors.Popup;
using DevExpress.XtraBars;

namespace EtelaatePaye.UsersSystem
{
    public partial class FrmAccesslevel2 : DevExpress.XtraEditors.XtraForm
    {
        public FrmAccesslevel2()
        {
            InitializeComponent();
        }
        public void FillcmbUsersList()
        {
            using (var dbContext = new MyContext())
            {
                try
                {
                    if (lblUserId.Text == "1")
                    {
                        // This line of code is generated by Data Source Configuration Wizard
                        dbContext.MsUsers.Where(s => s.UserIsActive == true && s.MsUserId != 1).Load();
                        // Bind data to control when loading complete
                        msUserBindingSource.DataSource = dbContext.MsUsers.Local.ToBindingList();
                    }
                    else
                    {
                        int _UserId = Convert.ToInt32(lblUserId.Text);
                        // This line of code is generated by Data Source Configuration Wizard
                        dbContext.MsUsers.Where(s => s.UserIsActive == true && s.MsUserId == _UserId).Load();
                        // Bind data to control when loading complete
                        msUserBindingSource.DataSource = dbContext.MsUsers.Local.ToBindingList();
                    }
                }
                catch (Exception ex)
                {
                    XtraMessageBox.Show("عملیات با خطا مواجه شد" + "\n" + ex.Message,
                        "پیغام", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
        }
        public void FilltreeList_DafaterMali()
        {
            using (var dbContext = new MyContext())
            {
                try
                {
                    if (dbContext.MsMajmoes.Any())
                    {
                        // Call the Load method to get the data for the given DbSet from the database.
                        dbContext.MsAccessLevelDafaterMalis.Where(s => s.IsActive == true).OrderBy(s => s.KeyId).Load();
                        // This line of code is generated by Data Source Configuration Wizard
                        msAccessLevelDafaterMalisBindingSource.DataSource = dbContext.MsAccessLevelDafaterMalis.Local.ToBindingList();
                    }
                }
                catch (Exception ex)
                {
                    XtraMessageBox.Show("عملیات با خطا مواجه شد" + "\n" + ex.Message,
                        "پیغام", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
        }
        public void FilltreeList_CodingHesabdari()
        {
            using (var dbContext = new MyContext())
            {
                try
                {
                    if (dbContext.MsMajmoes.Any())
                    {
                        // Call the Load method to get the data for the given DbSet from the database.
                        dbContext.EpAccessLevelCodingHesabdaris.Where(s => s.IsActive == true).OrderBy(s => s.KeyId).Load();
                        // This line of code is generated by Data Source Configuration Wizard
                        epAccessLevelCodingHesabdarisBindingSource.DataSource = dbContext.EpAccessLevelCodingHesabdaris.Local.ToBindingList();
                    }
                }
                catch (Exception ex)
                {
                    XtraMessageBox.Show("عملیات با خطا مواجه شد" + "\n" + ex.Message,
                        "پیغام", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
        }

        private void FrmAccesslevel2_Load(object sender, EventArgs e)
        {
            FillcmbUsersList();
            FilltreeList_DafaterMali();
            FilltreeList_CodingHesabdari();
            //treeListDafaterMali.ExpandAll();

            //using (var db = new MyContext())
            //{
            //    try
            //    {
            //        int _UserId = Convert.ToInt32(lblUserId.Text);
            //        var q1 = db.RmsUserBmsAccessLevelMenus.Where(s => s.MsUserId == _UserId).ToList();
            //        if (q1.Count() > 0)
            //        {
            //            //btnCreate.Visibility = q1.Any(s => s.MsAccessLevelMenuId == 55331) ? BarItemVisibility.Never : BarItemVisibility.Always;
            //            //btnSave_ListDafaterMali.Visibility = q1.Any(s => s.MsAccessLevelMenuId == 550302021) ? BarItemVisibility.Never : BarItemVisibility.Always;
            //            //btnDelete.Visibility = q1.Any(s => s.MsAccessLevelMenuId == 55333) ? BarItemVisibility.Never : BarItemVisibility.Always;
            //        }
            //    }
            //    catch (Exception ex)
            //    {
            //        XtraMessageBox.Show("عملیات با خطا مواجه شد" + "\n" + ex.Message,
            //            "پیغام", MessageBoxButtons.OK, MessageBoxIcon.Error);
            //    }
            //}

        }

        private void cmbUsersList_EditValueChanged(object sender, EventArgs e)
        {
            using (var db = new MyContext())
            {
                try
                {
                    int _UserId = Convert.ToInt32(cmbUsersList.EditValue);
                    var q = db.RmsUserBmsAccessLevelDafaterMalis.Where(f => f.MsUserId == _UserId).ToList();
                    panelControl1.Enabled = true;
                    btnPrintPreview.Enabled = true;
                    if (q.Count > 0)
                    {
                        treeListDafaterMali.CheckAll();
                        q.ForEach(item =>
                        {
                            var node1 = treeListDafaterMali.FindNodeByKeyID(item.KeyId);
                            if (node1 != null)
                                treeListDafaterMali.SetNodeCheckState(node1, CheckState.Unchecked, false);
                        });
                    }
                    else
                        treeListDafaterMali.CheckAll();
                }
                catch (Exception ex)
                {
                    XtraMessageBox.Show("عملیات با خطا مواجه شد" + "\n" + ex.Message,
                        "پیغام", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }

        }

        private void btnPrintPreview_ItemClick(object sender, DevExpress.XtraBars.ItemClickEventArgs e)
        {
            if (ListDafaterMali.IsControlLoaded)
            {
                treeListDafaterMali.ShowRibbonPrintPreview();
            }
            else if (ListCodingHesabdari.IsControlLoaded)
            {
                treeListCodingHesabdari.ShowRibbonPrintPreview();
            }
        }

        private void treeListDafaterMali_AfterCheckNode(object sender, DevExpress.XtraTreeList.NodeEventArgs e)
        {
            int a = Convert.ToInt32(e.Node.GetValue(colKeyId1));
            if (a > 0)
            {
                if (a.ToString().Length == 2)
                {
                    if (treeListDafaterMali.FindNodeByKeyID(a).CheckState == CheckState.Checked)
                    {
                        treeListDafaterMali.GetNodeList().ForEach(item =>
                        {
                            if (Convert.ToInt32(item[colKeyId1]) > a)
                            {
                                if (a.ToString().Substring(0, 2) == item[colKeyId1].ToString().Substring(0, 2))
                                {
                                    var node1 = treeListDafaterMali.FindNodeByKeyID(item[colKeyId1]);
                                    treeListDafaterMali.SetNodeCheckState(node1, CheckState.Checked, false);
                                }
                            }
                        });
                    }
                    else
                    {
                        treeListDafaterMali.GetNodeList().ForEach(item =>
                        {
                            if (Convert.ToInt32(item[colKeyId1]) > a)
                            {
                                if (a.ToString().Substring(0, 2) == item[colKeyId1].ToString().Substring(0, 2))
                                {
                                    var node1 = treeListDafaterMali.FindNodeByKeyID(item[colKeyId1]);
                                    treeListDafaterMali.SetNodeCheckState(node1, CheckState.Unchecked, false);
                                }
                            }
                        });
                    }
                }
                else if (a.ToString().Length == 4)
                {
                    if (treeListDafaterMali.FindNodeByKeyID(a).CheckState == CheckState.Checked)
                    {
                        treeListDafaterMali.GetNodeList().ForEach(item =>
                        {
                            if (Convert.ToInt32(item[colKeyId1]) > a)
                            {
                                if (a.ToString().Substring(0, 4) == item[colKeyId1].ToString().Substring(0, 4))
                                {
                                    var node1 = treeListDafaterMali.FindNodeByKeyID(item[colKeyId1]);
                                    treeListDafaterMali.SetNodeCheckState(node1, CheckState.Checked, false);
                                }
                            }
                            else
                            {
                                if (item[colKeyId1].ToString().Length == 2)
                                {
                                    if (a.ToString().Substring(0, 2) == item[colKeyId1].ToString().Substring(0, 2))
                                    {
                                        var node1 = treeListDafaterMali.FindNodeByKeyID(item[colKeyId1]);
                                        treeListDafaterMali.SetNodeCheckState(node1, CheckState.Checked, false);
                                    }
                                }
                            }
                        });
                    }
                    else
                    {
                        treeListDafaterMali.GetNodeList().ForEach(item =>
                        {
                            if (Convert.ToInt32(item[colKeyId1]) > a)
                            {
                                if (a.ToString().Substring(0, 4) == item[colKeyId1].ToString().Substring(0, 4))
                                {
                                    var node1 = treeListDafaterMali.FindNodeByKeyID(item[colKeyId1]);
                                    treeListDafaterMali.SetNodeCheckState(node1, CheckState.Unchecked, false);
                                }
                            }
                            //else
                            //{
                            //    if (item[colKeyId].ToString().Length == 2)
                            //    {
                            //        if (a.ToString().Substring(0, 2) == item[colKeyId].ToString().Substring(0, 2))
                            //        {
                            //            var node1 = treeListDafaterMali.FindNodeByKeyID(item[colKeyId]);
                            //            treeListDafaterMali.SetNodeCheckState(node1, CheckState.Unchecked, false);
                            //        }
                            //    }
                            //}

                        });
                    }
                }
                else if (a.ToString().Length == 6)
                {
                    if (treeListDafaterMali.FindNodeByKeyID(a).CheckState == CheckState.Checked)
                    {
                        treeListDafaterMali.GetNodeList().ForEach(item =>
                        {
                            if (Convert.ToInt32(item[colKeyId1]) > a)
                            {
                                if (a.ToString().Substring(0, 6) == item[colKeyId1].ToString().Substring(0, 6))
                                {
                                    var node1 = treeListDafaterMali.FindNodeByKeyID(item[colKeyId1]);
                                    treeListDafaterMali.SetNodeCheckState(node1, CheckState.Checked, false);
                                }
                            }
                            else
                            {
                                if (item[colKeyId1].ToString().Length == 4)
                                {
                                    if (a.ToString().Substring(0, 4) == item[colKeyId1].ToString().Substring(0, 4))
                                    {
                                        var node1 = treeListDafaterMali.FindNodeByKeyID(item[colKeyId1]);
                                        treeListDafaterMali.SetNodeCheckState(node1, CheckState.Checked, false);
                                    }
                                }
                                else if (item[colKeyId1].ToString().Length == 2)
                                {
                                    if (a.ToString().Substring(0, 2) == item[colKeyId1].ToString().Substring(0, 2))
                                    {
                                        var node1 = treeListDafaterMali.FindNodeByKeyID(item[colKeyId1]);
                                        treeListDafaterMali.SetNodeCheckState(node1, CheckState.Checked, false);
                                    }
                                }
                            }
                        });
                    }
                    else
                    {
                        treeListDafaterMali.GetNodeList().ForEach(item =>
                        {
                            if (Convert.ToInt32(item[colKeyId1]) > a)
                            {
                                if (a.ToString().Substring(0, 6) == item[colKeyId1].ToString().Substring(0, 6))
                                {
                                    var node1 = treeListDafaterMali.FindNodeByKeyID(item[colKeyId1]);
                                    treeListDafaterMali.SetNodeCheckState(node1, CheckState.Unchecked, false);
                                }
                            }
                            //else
                            //{
                            //    if (item[colKeyId].ToString().Length == 4)
                            //    {
                            //        if (a.ToString().Substring(0, 4) == item[colKeyId].ToString().Substring(0, 4))
                            //        {
                            //            var node1 = treeListDafaterMali.FindNodeByKeyID(item[colKeyId]);
                            //            treeListDafaterMali.SetNodeCheckState(node1, CheckState.Unchecked, false);
                            //        }
                            //    }
                            //    else if (item[colKeyId].ToString().Length == 2)
                            //    {
                            //        if (a.ToString().Substring(0, 2) == item[colKeyId].ToString().Substring(0, 2))
                            //        {
                            //            var node1 = treeListDafaterMali.FindNodeByKeyID(item[colKeyId]);
                            //            treeListDafaterMali.SetNodeCheckState(node1, CheckState.Unchecked, false);
                            //        }
                            //    }
                            //}
                        });
                    }
                }
                else
                {
                    if (treeListDafaterMali.FindNodeByKeyID(a).CheckState == CheckState.Checked)
                    {
                        treeListDafaterMali.GetNodeList().ForEach(item =>
                        {
                            if (item[colKeyId1].ToString().Length == 6)
                            {
                                if (a.ToString().Substring(0, 6) == item[colKeyId1].ToString().Substring(0, 6))
                                {
                                    var node1 = treeListDafaterMali.FindNodeByKeyID(item[colKeyId1]);
                                    treeListDafaterMali.SetNodeCheckState(node1, CheckState.Checked, false);
                                }
                            }
                            else if (item[colKeyId1].ToString().Length == 4)
                            {
                                if (a.ToString().Substring(0, 4) == item[colKeyId1].ToString().Substring(0, 4))
                                {
                                    var node1 = treeListDafaterMali.FindNodeByKeyID(item[colKeyId1]);
                                    treeListDafaterMali.SetNodeCheckState(node1, CheckState.Checked, false);
                                }
                            }
                            else if (item[colKeyId1].ToString().Length == 2)
                            {
                                if (a.ToString().Substring(0, 2) == item[colKeyId1].ToString().Substring(0, 2))
                                {
                                    var node1 = treeListDafaterMali.FindNodeByKeyID(item[colKeyId1]);
                                    treeListDafaterMali.SetNodeCheckState(node1, CheckState.Checked, false);
                                }
                            }
                        });
                    }
                    #region
                    //else
                    //{
                    //    treeListDafaterMali.GetNodeList().ForEach(item =>
                    //    {
                    //        if (item[colKeyId].ToString().Length == 6)
                    //        {
                    //            if (a.ToString().Substring(0, 6) == item[colKeyId].ToString().Substring(0, 6))
                    //            {
                    //                var node1 = treeListDafaterMali.FindNodeByKeyID(item[colKeyId]);
                    //                treeListDafaterMali.SetNodeCheckState(node1, CheckState.Unchecked, false);
                    //            }
                    //        }
                    //        else if (item[colKeyId].ToString().Length == 4)
                    //        {
                    //            if (a.ToString().Substring(0, 4) == item[colKeyId].ToString().Substring(0, 4))
                    //            {
                    //                var node1 = treeListDafaterMali.FindNodeByKeyID(item[colKeyId]);
                    //                treeListDafaterMali.SetNodeCheckState(node1, CheckState.Unchecked, false);
                    //            }
                    //        }
                    //        else if (item[colKeyId].ToString().Length == 2)
                    //        {
                    //            if (a.ToString().Substring(0, 2) == item[colKeyId].ToString().Substring(0, 2))
                    //            {
                    //                var node1 = treeListDafaterMali.FindNodeByKeyID(item[colKeyId]);
                    //                treeListDafaterMali.SetNodeCheckState(node1, CheckState.Unchecked, false);
                    //            }
                    //        }
                    //    });

                    //}
                    #endregion

                }
            }
        }

        private void btnSave_ListDafaterMali_Click(object sender, EventArgs e)
        {
            using (var db = new MyContext())
            {
                try
                {
                    int _UserId = Convert.ToInt32(cmbUsersList.EditValue);
                    /////////////////////////// ویرایش سطح دسترسی کاربران به لیست دفاتر مالی /////////////////////////////
                    var q = db.RmsUserBmsAccessLevelDafaterMalis.Where(s => s.MsUserId == _UserId).ToList();
                    if (q.Count > 0)
                    {
                        db.RmsUserBmsAccessLevelDafaterMalis.RemoveRange(q);
                    }

                    foreach (var item in treeListDafaterMali.GetNodeList().Except(treeListDafaterMali.GetAllCheckedNodes()))
                    {
                        if (item.CheckState == CheckState.Unchecked)
                        {
                            RmsUserBmsAccessLevelDafaterMali obj1 = new RmsUserBmsAccessLevelDafaterMali();
                            obj1.MsUserId = _UserId;
                            obj1.UserName = cmbUsersList.Edit.GetDisplayText(cmbUsersList.EditValue);
                            obj1.MsAccessLevelDafaterMaliId = Convert.ToInt32(item.GetValue(colMsAccessLevelDafaterMaliId1));
                            obj1.KeyId = Convert.ToInt32(item.GetValue(colKeyId1));
                            obj1.MajmoeId = Convert.ToInt32(item.GetValue(colMajmoeId1));
                            obj1.VahedId = Convert.ToInt32(item.GetValue(colVahedId1));
                            obj1.ShobeId = Convert.ToInt32(item.GetValue(colShobeId1));
                            obj1.DoreMaliId = Convert.ToInt32(item.GetValue(colDoreMaliId1));
                            obj1.IsActive = Convert.ToBoolean(item.GetValue(colIsActive1));

                            db.RmsUserBmsAccessLevelDafaterMalis.Add(obj1);
                        }
                    }
                    //////////////////////////////////////////////////////////////////////////////////////////////////
                    db.SaveChanges();
                    XtraMessageBox.Show("عملیات باموفقیت انجام شد", "پیغام", MessageBoxButtons.OK, MessageBoxIcon.Information);
                }
                catch (Exception ex)
                {
                    XtraMessageBox.Show("عملیات با خطا مواجه شد" + "\n" + ex.Message,
                        "پیغام", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
        }

        private void chkSelectAll_ListDafaterMali_CheckedChanged(object sender, EventArgs e)
        {
            if (chkSelectAll_ListDafaterMali.Checked)
                treeListDafaterMali.CheckAll();
            else
                treeListDafaterMali.UncheckAll();
        }

        private void chkOpenClose_ListDafaterMali_CheckedChanged(object sender, EventArgs e)
        {
            if (chkOpenClose_ListDafaterMali.Checked)
                treeListDafaterMali.ExpandAll();
            else
                treeListDafaterMali.CollapseAll();
        }

        private void chkSelectAll_ListCodingHesabdari_CheckedChanged(object sender, EventArgs e)
        {
            if (chkSelectAll_ListCodingHesabdari.Checked)
                treeListCodingHesabdari.CheckAll();
            else
                treeListCodingHesabdari.UncheckAll();
        }

        private void chkOpenClose_ListCodingHesabdari_CheckedChanged(object sender, EventArgs e)
        {
            if (chkOpenClose_ListCodingHesabdari.Checked)
                treeListCodingHesabdari.ExpandAll();
            else
                treeListCodingHesabdari.CollapseAll();
        }

        private void btnSave_ListCodingHesabdari_Click(object sender, EventArgs e)
        {
            using (var db = new MyContext())
            {
                try
                {
                    int _UserId = Convert.ToInt32(cmbUsersList.EditValue);
                    /////////////////////////// ویرایش سطح دسترسی کاربران به لیست کدینگ حسابداری /////////////////////////////
                    var q = db.RmsUserBepAccessLevelCodingHesabdaris.Where(s => s.UserId == _UserId).ToList();
                    if (q.Count > 0)
                    {
                        db.RmsUserBepAccessLevelCodingHesabdaris.RemoveRange(q);
                    }

                    foreach (var item in treeListCodingHesabdari.GetNodeList().Except(treeListCodingHesabdari.GetAllCheckedNodes()))
                    {
                        if (item.CheckState == CheckState.Unchecked)
                        {
                            RmsUserBepAccessLevelCodingHesabdari obj1 = new RmsUserBepAccessLevelCodingHesabdari();
                            obj1.UserId = _UserId;
                            obj1.CodingHesabdariId = Convert.ToInt32(item.GetValue(colId2));
                            obj1.KeyId = Convert.ToInt32(item.GetValue(colKeyId2));
                            obj1.HesabGroupId = Convert.ToInt32(item.GetValue(colHesabGroupId2));
                            obj1.HesabColId = Convert.ToInt32(item.GetValue(colHesabColId2));
                            obj1.HesabMoinId = Convert.ToInt32(item.GetValue(colHesabMoinId2));
                            obj1.IsActive = Convert.ToBoolean(item.GetValue(colIsActive2));

                            db.RmsUserBepAccessLevelCodingHesabdaris.Add(obj1);
                        }
                    }
                    //////////////////////////////////////////////////////////////////////////////////////////////////
                    db.SaveChanges();
                    XtraMessageBox.Show("عملیات باموفقیت انجام شد", "پیغام", MessageBoxButtons.OK, MessageBoxIcon.Information);
                }
                catch (Exception ex)
                {
                    XtraMessageBox.Show("عملیات با خطا مواجه شد" + "\n" + ex.Message,
                        "پیغام", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
        }
    }
}